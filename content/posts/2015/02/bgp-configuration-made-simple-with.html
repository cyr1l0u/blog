---
title: "BGP Configuration Made Simple with Cumulus Linux"
date: "2015-02-23T09:02:00.000+01:00"
tags: [ SDN,BGP ]
---

<p>BGP is without doubt the most scalable routing protocol, which made it a popular choice for large-scale deployments from service provider networks to <a href="http://blog.ipspace.net/search?q=DMVPN+BGP">enterprise WAN/VPN</a> networks and even <a href="http://blog.ipspace.net/2013/10/exception-routing-with-bgp-sdn-done.html">data centers</a>. Its only significant drawback is the tedious configuration process (which almost reminds me of writing COBOL programs decades ago).<!--more--></p>
<p>The Cumulus Networks routing team decided to change that and added numerous BGP configuration enhancements to Quagga, the routing daemon used by Cumulus Linux. You might want to watch the <a href="https://vimeo.com/119403106">Data Center Architectures</a> video from <a href="http://techfieldday.com/appearance/cumulus-networks-presents-at-networking-field-day-9/">Cumulus&#x2019; Network Field Day 9 presentation</a> for the introduction to the topic before delving into the details.</p>
<p class="note">Some of the Cumulus Linux/Quagga features described in this blog post might be experimental extensions at this time &ndash; you can get access to them, but are not supposed to use them in production networks before testing them in a lab. The experimental features are usually rolled into one of the next major releases.</p>
<h4>Configure BGP neighbor on an interface</h4><p>Here&#x2019;s how you&#x2019;d usually configure a BGP neighbor:</p>
<pre class="code">router&nbsp;bgp&nbsp;&lt;as-number&gt;<br />&nbsp;&nbsp;neighbor&nbsp;&lt;address&gt;&nbsp;remote-as&nbsp;&lt;as-number&gt;</pre><p>This is how you can do it with Quagga in Cumulus Linux:</p>
<pre class="code">router&nbsp;bgp&nbsp;&lt;as-number&gt;<br />&nbsp;&nbsp;neighbor&nbsp;&lt;interface&gt;&nbsp;remote-as&nbsp;&lt;as-number&gt;</pre><p class="info">Do I have to mention how easy it is to create a template configuration for a ToR switch running BGP on four uplinks? Now try doing that with traditional BGP configuration.</p>
<p>After configuring an interface neighbor, the router tries to figure out the neighbor&#x2019;s IP address. That&#x2019;s easy to do for IPv6 (use link-local addresses), and for interfaces with /30 or /31 IPv4 subnets&hellip; but Cumulus Linux allows you to run BGP (IBGP or EBGP) over <a href="http://blog.ipspace.net/2014/06/unnumbered-ospf-interfaces-in-quagga.html">unnumbered interfaces</a>.</p>
<p class="info">You still need a numbered interface on every box &ndash; preferably a loopback interface &ndash; to access the box and to give the box an IPv[46] address to use in ICMP replies and other switch-generated traffic (syslog, SNMP&hellip;). </p>
<p>It was always possible to run IBGP over unnumbered interfaces: configure an IGP, run IBGP between loopback interfaces, and let IGP sort out how to exchange traffic between the BGP speakers. But how do you get EBGP to run over unnumbered interfaces without using IGP?</p>
<p>Cumulus routing team used one of the more obscure BGP-related RFCs to get the job done. <a href="https://tools.ietf.org/html/rfc5549">RFC 5549</a> documents how you exchange IPv4 BGP prefixes with IPv6 next hops (for more details see the <a href="https://ripe65.ripe.net/presentations/101-RIPE65.pdf">RIPE presentation by AMS-IX</a>), and when you combine that with the ability to run EBGP across link-local IPv6 addresses, you get a one-line BGP neighbor configuration that is totally independent from the IPv4/IPv6 addressing in your network and thus easy to turn into a template and automate.</p>
<p>Final question: how do you get the LLA of your neighbor? Easy: listen to its ND or RA messages.</p>
<p><strong>Notes</strong><strong> and caveats</strong><strong>:</strong></p>
<ul class="ListParagraph"><li>You can use the interface-based BGP neighbors with devices from other vendors if you use /30 or /31 subnet mask on the interface (in that case Cumulus Linux uses standard BGP);</li>
<li>You don&#x2019;t have to run IPv6 in your network to get this feature to work on unnumbered interfaces &ndash; just make sure you haven&#x2019;t disabled IPv6 on the interfaces you want to use in BGP configuration;</li>
<li>You can use this feature for IPv6 BGP sessions with any third-party box that supports BGP over LLA (Cisco&#x2019;s IPv6/security guru Eric Vyncke <a href="https://tools.ietf.org/html/rfc7404">published an RFC describing this idea</a>&hellip; but unfortunately that had no impact on messy configuration you have to use in Cisco IOS to get it to work);</li>
<li>If you want to use interface-based BGP neighbors over unnumbered IPv4 interfaces, the BGP neighbor has to support RFC 5549, and I&#x2019;m not aware of any major vendor doing that;</li>
<li>Obviously this feature works only over point-to-point interface. You&#x2019;d need something like <a href="http://blog.ipspace.net/2014/03/scaling-bgp-based-dmvpn-networks.html">dynamic BGP neighbors from Cisco IOS</a> for multi-access (example: mGRE) scenarios.</li>
</ul>
<h4>Getting rid of AS numbers</h4><p>The other major pain of BGP configuration syntax (particularly when you&#x2019;re trying to generate standard configuration templates) is the requirement to specify neighbor AS number in the <strong>neighbor </strong>statement. Here&#x2019;s how Cumulus routing team solved that problem:</p>
<pre class="code">router&nbsp;bgp&nbsp;&lt;as-number&gt;<br />&nbsp;&nbsp;neighbor&nbsp;&lt;interface&gt;&nbsp;remote-as&nbsp;<strong>internal</strong><br />&nbsp;&nbsp;neighbor&nbsp;&lt;interface&gt;&nbsp;remote-as&nbsp;<strong>external</strong></pre><p>The <strong>remote-as internal </strong>part of the <strong>neighbor </strong>statement is obvious &ndash; use my own BGP AS number. One has to wonder why nobody else is using this syntax; maybe they&#x2019;re too busy copying industry-standard CLI.</p>
<p>The <strong>remote-as external </strong>feature is where Cumulus engineers got slightly creative. BGP speakers advertise their AS number in the BGP OPEN message, and the usual behavior is to close the session if the AS number in the incoming OPEN message doesn&#x2019;t match the number configured on the BGP <strong>neighbor</strong> statement. Instead of that, the new code they wrote for Quagga ignores the strict AS check, accepts the AS number advertised by the neighbor, and uses it later on in the same way as if it would have been configured in the router configuration.</p>
<p class="warn">Do I have to tell you not to use this feature with untrusted neighbors? It&#x2019;s OK to trust an adjacent switch in your data center (or use <a href="http://docs.cumulusnetworks.com/display/CL25/Prescriptive+Topology+Manager+-+PTM">Prescriptive Topology Manager</a> if you want to be sure your data center is wired correctly), but definitely <em>NOT</em> OK to trust your customers or peering partners. See <a href="http://blog.ipspace.net/2015/02/rfc-7454-bgp-operations-and-security.html">RFC 7454</a> for more details on what not to do with BGP.</p>
<h4>Summary</h4><p>Regardless of what I think about the whole concept of whitebox switching, I love creative solutions;) It&#x2019;s refreshing to see how startups with no legacy codebase to protect solve annoyances that have been bothering us for decades. Great job!</p>
<p><strong>Disclosure</strong>: Cumulus Networks was indirectly covering some of the costs of my attendance at the Network Field Day 9 event. <a href="http://blog.ipspace.net/p/networking-tech-field-day-disclaimer.html">More&hellip;</a></p>

