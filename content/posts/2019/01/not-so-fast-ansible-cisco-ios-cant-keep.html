---
url: /2019/01/not-so-fast-ansible-cisco-ios-cant-keep.html
title: "Not So Fast Ansible, Cisco IOS Can’t Keep Up…"
date: "2019-01-29T08:44:00.000+01:00"
tags: [ Ansible,MPLS VPN ]
---

<p>Remember how earlier releases of Nexus-OS <a href="https://blog.ipspace.net/2017/04/lets-drop-some-random-commands-shall-we.html">started dropping configuration commands if you were typing them too quickly</a> (and how it was declared a feature ;)?</p>
<p><a href="https://nexthop.global/">Mark Fergusson</a> had a similar experience on Cisco IOS. All he wanted to do was to use Ansible to configure a VRF, an interface in the VRF, and OSPF routing process on Cisco CSR 1000v running software release 15.5(3).</p>
<p>Here’s what he was trying to deploy. Looks like a configuration straight out of an MPLS book, right?<!--more--></p>
<pre class="code">ip vrf Customer_A<br/> rd 65000:1<br/> route-target import 65000:1<br/> route-target export 65000:1<br/>!<br/>interface GigabitEthernet1.146<br/> ip vrf forwarding Customer_A<br/> ip address 155.1.146.1 255.255.255.0<br/> ip ospf 2 area 0<br/><br/>router ospf 2 vrf Customer_A<br/>  router-id 155.1.146.1<br/>  redistribute bgp 65000 subnets</pre><p>Guess what… when he tried to push that configuration to his CSR 1000v with Ansible <strong>ios_config </strong>module the in-VRF OSPF router process refused to start claiming it cannot get a router ID (<em>%OSPF-4-NORTRID: OSPF process 2 failed to allocate unique router-id and cannot start</em>). The whole thing worked when he tried to configure OSPF a bit later – looks like it takes some time to get a subinterface ready after it’s been configured, and if you’re typing too quickly you’re out of luck.</p>
<p class="info">Keep in mind that Ansible uses SSH session to configure a Cisco IOS device, so it’s doing the exact same thing as if you’d be a really fast typist.</p>
<p>I could see two immediate solutions to this problem:</p>
<ul class="ListParagraph"><li>Get a router that <a href="https://blog.ipspace.net/2016/10/network-automation-rfp-requirements.html">has a decent API</a> and all-or-nothing commit mechanism;</li>
<li>Split the configuration in two parts and push them to the device using two <strong>ios_config </strong>calls. It takes Ansible long enough to work through its gazillion layers of abstraction for Cisco IOS to realize what just happened.</li>
</ul>
<p>On a somewhat tangential note, a friend of mine <a href="https://github.com/nremeetup/talks/blob/master/December_2018/NRE_December_2018.pptx">called the current state of network automation</a> “Unix Scripting in 1970s”. Unfortunately he wasn’t too far off…</p>
<hr/><p>To learn more about network automation with Ansible start with our <a href="https://www.ipspace.net/Ansible_for_Networking_Engineers">Ansible for Networking Engineers</a> webinar and when you’re ready to move from writing playbooks to building solutions <a href="https://www.ipspace.net/Building_Network_Automation_Solutions#register">enroll</a> into <a href="https://www.ipspace.net/Building_Network_Automation_Solutions">Building Network Automation Solutions online course</a>.</p>

