---
title: "VMware NSX Killed My EVPN Fabric"
date: "2019-10-09T08:02:00.000+02:00"
tags: [ EVPN,NSX,multicast ]
---

<p>A while ago I had an interesting discussion with someone running VMware NSX on top of VXLAN+EVPN fabric - a pretty common scenario considering:</p>
<ul><li>NSX’s insistence on having all VXLAN uplink <em>from the same server</em> in the same subnet;</li>
<li>Data center switching vendors being on a lemming-like run praising EVPN+VXLAN;</li>
<li>Non-FANG environments being somewhat reluctant to connect a server to a single switch.</li>
</ul>
<p>His fabric was running well… apart from the weird times when someone started tons of new VMs.<!--more--> In those moments multicast traffic generated by NSX-V to flood all the ARPs and gratuitous ARPs generated by the newly-started VMs killed the control plane of ToR switches resulting in lost BGP sessions (and a widespread disaster).</p>
<p class='update'>2019-10-10: Made the <em>all uplinks</em> claim more explicit. Also inserted the information about default settings.</p>
<p>We had quite intricate discussions of (inadequacy of) Control-Plane Protection implemented by the vendor he was using, and finally it dawned on me: maybe CoPP doesn’t work because the multicasts are SUPPOSED to get to the switch CPU.</p>
<p>After that it was pretty easy to identify the culprit: someone configured 224.0.0.0/24 as the multicast range used for NSX-V VXLAN BUM flooding. When looking through the <a href="https://www.iana.org/assignments/multicast-addresses/multicast-addresses.xhtml#multicast-addresses-1">IANA list of addresses in that range</a> it’s quite easy to see what’s going on: every host should listen to 224.0.0.1 and all routers should listen to 224.0.0.2 (plus a few others).</p>
<p>It’s easy to start pointing fingers: VMware should never accept 224.0.0.0/24 as the multicast range, the NSX administrators should know about reserved multicast ranges etc… but in reality, whoever coded the NSX GUI blindly followed the “top nibble must be 0xE” recipe, and the sysadmins probably followed the help screen saying “enter a range between 224.0.0.0 and 239.255.255.255”.</p>
<p class='info'>A friend working for VMware pointed out that they recommended using unicast mode for years, and that the default flooding mode is now Unicast (it was Hybrid mode in earlier releases), so it looks like there were a few things going wrong in that environment.</p>
<p>Moral of the story: when deploying a new technology, it helps to understand how it really works (and NSX-V design guides are pretty good)… or you could ask someone who does (hint: in this case the fellow networking engineer ;).</p>
<p>Want to know more about VMware NSX? I covered NSX-V details last year, and will start <a href="https://www.ipspace.net/VMware_NSX_Technical_Deep_Dive">deep dive into NSX-T</a> in November 2019. All you need to join the live sessions or enjoy the existing NSX content is a <a href="https://www.ipspace.net/Subscription/Individual">Standard ipSpace.net Subscription</a>.</p>

