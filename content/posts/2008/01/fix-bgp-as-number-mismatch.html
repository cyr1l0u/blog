---
title: "Fix a BGP AS number mismatch"
date: "2008-01-09T06:52:00.000+01:00"
tags: [ BGP ]
---

Sometimes you end up having wrong BGP AS number throughout your network. It could be a result of an unexpected merger or split or you could have started using a private BGP AS number and realized you have to connect to the Internet using a real AS number. The proper solution would be a total reconfiguration of the whole network, but of course not many engineers have the time and courage to do it ;), so it's time to introduce another kludge: the <strong>neighbor local-as</strong> configuration command.&lt;!--more--&gt;For example, let's assume your AS number should be 20, but you're using a private AS 65001, as shown in the following figure:<a href="http://bp1.blogger.com/_K_pkZO5-tTg/R4E3wJwqVxI/AAAAAAAABA8/Slzp6-Bi2oY/s1600-h/bgp_1.jpg"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5152460749081827090" src="http://bp1.blogger.com/_K_pkZO5-tTg/R4E3wJwqVxI/AAAAAAAABA8/Slzp6-Bi2oY/s400/bgp_1.jpg" style="display:block; margin:10px auto; text-align:center;cursor:pointer; cursor:hand;"/></a>To retain the AS 65001 internally but appear as AS 20 to the outside world, you could use the following configuration on R1:<pre class="code">router bgp 65001<br/> neighbor 10.0.0.18 remote-as 65001<br/> neighbor 10.0.0.18 description IBGP to R2<br/> neighbor 10.1.0.2 remote-as 10<br/> neighbor 10.1.0.2 local-as 20<br/> neighbor 10.1.0.2 description EBGP to AS 10</pre>This configuration would ensure that the EBGP session with AS 10 is established (R1 pretends that it belongs to AS 20 on this session), but the AS path propagated to AS 30 is somewhat odd …<pre class="code">AS30#<strong>show ip bgp | include 20</strong><br/>*&gt; 172.16.0.0     10.1.0.5      0 <span class="high">20 65001 20 10 i</span></pre>… making your network appear as a set of nested autonomous systems:<a href="http://bp2.blogger.com/_K_pkZO5-tTg/R4E3wZwqVyI/AAAAAAAABBE/zKZX7ZXzxhM/s1600-h/bgp_2.jpg"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5152460753376794402" src="http://bp2.blogger.com/_K_pkZO5-tTg/R4E3wZwqVyI/AAAAAAAABBE/zKZX7ZXzxhM/s400/bgp_2.jpg" style="display:block; margin:10px auto; text-align:center;cursor:pointer; cursor:hand;"/></a>There are two reasons for the weird AS path:<ul><li>R1 inserts <strong>local-as</strong> into inbound EBGP updates</li>
<li>R2 (configured like R1) inserts <strong>local-as</strong> as well as its real AS (65001) in outbound EBGRP update</li>
</ul>
To fix the AS path, you need the <a href="http://www.cisco.com/univercd/cc/td/doc/product/software/ios124/124cg/hirp_c/ch05/hbgpdas.htm">BGP Support for Dual AS Configuration</a> introduced in IOS release 12.3T. This feature adds two options to the <strong>local-as</strong> configuration command:<ul><li><strong>no-prepend</strong> disables <strong>local-as</strong> prepending on incoming EBGP updates;</li>
<li><strong>replace-as</strong> replaces router's own AS with <strong>local-as</strong> on outgoing EBGP updates.</li>
</ul>
When the configuration on R1 and R2 includes these two keywords …:<pre class="code">router bgp 65001<br/> neighbor 10.1.0.2 remote-as 10<br/> neighbor 10.1.0.2 local-as 20 no-prepend replace-as<br/> neighbor 10.1.0.2 description EBGP to AS 10</pre>… the path propagated through AS 65001/AS 20 looks as expected:<pre class="code">AS30#<strong>show ip bgp | include 20</strong><br/>*&gt; 172.16.0.0     10.1.0.5     0 <span class="high">20 10 i</span></pre>

