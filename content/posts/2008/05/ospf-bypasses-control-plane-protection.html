---
title: "OSPF bypasses Control Plane Host Subinterface"
date: "2008-05-08T07:27:00.003+02:00"
tags: [ security,OSPF ]
---

<p>I wanted to implement a mechanism that would automatically (using EEM) block unstable OSPF neighbors. Once you identify the neighbors to block (this should be the hard part), blocking them is easy if you're running point-to-point interfaces (you just make the interface <em>passive</em>), but blocking a single neighbor on a multi-access interface is a royal pain. I didn't want to use the access lists, as it would be very hard to integrate OSPF-specific filters with existing incoming access-lists configured on the interfaces. Control Plane Protection looked like the ideal tool to use; if I could drop certain inbound IP packets (OSPF hello packets) based on their source IP address (= unstable neighbor) and IP protocol (= OSPF), they would never get to the OSPF process and the adjacency would not form, resulting in a more stable network.</p>
<p class="update"><strong>Update:</strong> After the comment from William Chu, I've tested 12.4 mainstream release. OSPF is blocked as configured. Next I've re-read the documentation … and found that <a href="http://www.cisco.com/en/US/docs/ios/12_4t/12_4t4/htcpp.html#wp1082901">one of the documented restrictions</a> is that the host subinterface only filters UDP and TCP traffic. Configuring the service policy on the aggregate path (the <strong>control-plane</strong> keyword with no options) worked.</p>
<p>Before trying to figure out the integration between the SYSLOG messages and router configuration changes, I performed an easy test: I tried blocking all OSPF traffic in the <em>host control-plane</em> (the one controlling packets received by the IOS processes) with the following configuration:</p>
<pre class="code">class-map match-all BlockOSPF<br/> match access-group name BlockOSPF<br/>!<br/>!<br/>policy-map ControlPlane<br/> class BlockOSPF<br/>   drop<br/>!<br/>ip access-list extended BlockOSPF<br/> permit ospf any any<br/>!<br/>control-plane host<br/> service-policy input ControlPlane</pre>However, according to the <strong>show</strong> commands, the service policy did not identify any packets as belonging to the BlockOSPF class and the OSPF adjacencies were not affected:<pre class="code">C1#<strong>show policy-map control-plane host</strong><br/> Control Plane Host <br/><br/>  Service-policy input: ControlPlane<br/><br/>    Class-map: BlockOSPF (match-all)<br/>      0 packets, 0 bytes<br/>      5 minute offered rate 0 bps, drop rate 0 bps<br/>      Match: access-group name BlockOSPF<br/>      drop<br/><br/>    Class-map: class-default (match-any)<br/>      5 packets, 400 bytes<br/>      5 minute offered rate 0 bps, drop rate 0 bps<br/>      Match: any <br/>C1#<strong>show ip ospf neighbor</strong> <br/><br/>Neighbor ID     Pri   State           Dead Time   Address         Interface<br/>10.0.0.12         1   FULL/DR         00:00:30    10.0.1.2        FastEthernet0/0<br/>10.0.0.2          0   FULL/  -        00:00:33    10.0.0.2        Serial1/0.101<br/>10.0.2.2          0   FULL/  -        00:00:33    10.0.0.1        Serial1/0.100</pre>After a few more tests, I had to conclude that the Control Plane Protection using host subinterface <strong>does not work</strong> on OSPF packets (and it <s>might</s> <span style="color: red;">does not</span> work on other non-TCP/UDP traffic either). <s>Consequently you <em><strong>cannot protect your router from a DoS attack coming through an interface on which you have to run OSPF</strong></em></s><span style="color: red">To filter non-TCP/UDP traffic, use the aggregate path control plane protection</span>.

