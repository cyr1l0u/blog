---
url: /2020/01/evpn-auto-rd-and-duplicate-mac-addresses.html
title: "EVPN Auto-RD and Duplicate MAC Addresses"
date: "2020-01-15T07:56:00.000+01:00"
tags: [ EVPN ]
---

<p>Another <a href="https://blog.ipspace.net/2019/12/evpn-route-targets-route-distinguishers.html">EVPN reader question</a>, this time focusing on auto-RD functionality and how it works with duplicate MAC addresses:</p>
<blockquote><p>If set to <em>Auto</em>, RD generated will be different for the same VNI across the EVPN switches. If the same route (MAC and/or IP) is present under different leaves of the same L2VNI, since the RD is different there is no best path selection and both will be considered. It’s a misconfiguration and shouldn’t be allowed. How will the BGP deal with this?</p>
</blockquote>
<div class="note" data-markdown="1">If the above sentence sounded like Latin, go through short EVPN terminology first (and I would suggest watching the <a href="https://www.ipspace.net/EVPN_Technical_Deep_Dive">EVPN Technical Deep Dive</a> webinar). </div>
<!--more--><p>Let's start with an interesting fact: while we usually had to specify VRF RD values in MPLS/VPN, EVPN standard defined a procedure where RD would be auto-generated from a PE IP address and VLAN ID. That means that <em>the same MAC address</em> would appear as two distinct EVPN Type-2 prefixes when coming from two different PE-devices. BGP will happily process the two prefixes and tag them for inclusion into the local MAC table… and that’s where it gets interesting:</p>
<ul><li>If an EVPN PE-device figures out it has learned the same MAC address locally (through dynamic MAC learning) and through EVPN BGP update, the observed MAC address duplication might have been caused by a MAC (VM) move. <a href="https://tools.ietf.org/html/rfc7432#section-15">MAC mobility</a> procedures kick in, and eventually we’re left with a single MAC address.</li>
<li>In case of true misconfiguration, the MAC mobility procedure goes into an endless loop, and EVPN RFC addresses that <a href="https://tools.ietf.org/html/rfc7432#section-15.1">with a duplicate-MAC timer</a>.</li>
</ul>
<p>Long story short: BGP has nothing to do with duplicate MAC addresses, it’s just passing prefixes around the network. The EVPN devices discover duplicate MAC addresses when importing Type-2 EVPN routes into local MAC-VRF tables, and try to rectify the situation using MAC mobility procedures defined in RFC 7432.</p>
<p>For more details watch our <a href="https://www.ipspace.net/EVPN_Technical_Deep_Dive">EVPN Technical Deep Dive</a> webinar or <a href="https://tools.ietf.org/html/rfc7432">go straight to the source</a> (RFC 7432).</p>

