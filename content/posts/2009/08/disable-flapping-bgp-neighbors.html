---
title: "Disable flapping BGP neighbors"
date: "2009-08-28T06:35:00.000+02:00"
tags: [ BGP ]
---

<div class="bloggerBody"><p><a href="http://wiki.nil.com/"><img class="ImgFLTright" src="http://www.ioshints.info/images/Wiki.png"/></a>It looks like we’re bound to <a href="http://www.renesys.com/blog/2009/08/staring-into-the-gorge.shtml">experience a widespread BGP failure once every few months</a>. They all follow the same pattern:</p>
<ul><li>A “somewhat” undertested BGP implementation starts advertising paths with “unexpected” set of attributes.</li>
<li>A specific downstream BGP implementation (and it could be a different implementation every time) a few hops down the road hiccups and sends a BGP notification message to its upstream neighbor.</li>
<li>BGP session must be reset following a notification message; the routes advertised over it are lost and withdrawn, causing widespread ripples across the Internet.</li>
<li>The offending session is reestablished seconds later and the same set of routes is sent again, causing the same failure and a session reset. If the session stays up long enough (because the routers have to exchange approximately 300,000 routes), some of the newly received routes might get propagated and will flap again when the session is reset.</li>
<li>The cyclical behavior continues until a manual intervention.</li>
</ul>
<p>I don’t understand why Cisco IOS allows the cyclical BGP session behavior (as it’s pretty obvious things will not get better by themselves once the same session is reset a few times), but there’s at least something we can do with Embedded Event Manager: <a href="http://wiki.nil.com/Disable_flapping_BGP_neighbors">shut down the offending neighbor after seeing the BGP-3-NOTIFICATION syslog message often enough in a short period of time</a>.</p>
<p style="text-align: right;">You’ll find the <a href="http://wiki.nil.com/Disable_flapping_BGP_neighbors">EEM applet that shuts down a flapping BGP neighbor</a> in the <a href="http://wiki.nil.com/">CT3 wiki</a>.</p>
</div>

