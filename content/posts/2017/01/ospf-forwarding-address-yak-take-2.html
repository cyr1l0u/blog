---
title: "OSPF Forwarding Address YAK: Take 2"
date: "2017-01-26T08:48:00.000+01:00"
tags: [ Design,OSPF ]
---

<p>In my initial <a href="http://blog.ipspace.net/2017/01/ospf-forwarding-address-yet-another.html">OSPF Forwarding Address blog post</a> I described a common Forwarding Address (FA) use case (at least as preached on the Internet): two ASBRs connected to a single external subnet with route redistributing configured only on one of them.</p>
<p>That design is clearly broken from the reliability perspective, but are there other designs where OSPF FA might make sense?<!--more--></p>
<p>Here&#x2019;s another more convoluted design: two ASBRs are connected to the same external subnet implemented with Metro Ethernet. One ASBR has 1 Gbps connection to the Metro Ethernet service, the other one has 100 Mbps connection.</p>
<p>Fixing the errors of the previous broken design we&#x2019;re running BGP on both ASBRs and redistributing BGP routes into OSPF on both of them. We have full redundancy, but suboptimal forwarding: C1 has two equal-cost paths to external destination, while in reality one of them has 10 times less bandwidth than the other one.</p>
<div class='separator'><a href="https://3.bp.blogspot.com/-PQ3dVJzfWIk/WIRjk5G8kZI/AAAAAAAAIt8/EKbq--ZETosEHWGYsQnnHCao94_HsP5uwCLcB/s1600/OSPF_FA_BW_1.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-PQ3dVJzfWIk/WIRjk5G8kZI/AAAAAAAAIt8/EKbq--ZETosEHWGYsQnnHCao94_HsP5uwCLcB/s550/OSPF_FA_BW_1.png" /></a></div>
<p>Here are the relevant parts of the OSPF topology database and IP routing table on C1:</p>
<p class="codecaption">OSPF Type-5 LSAs on C1</p>
<pre class="code">C1#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.3)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;40<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.0.2&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.1<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0xA154<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;1<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;0.0.0.0<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;65001<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;25<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.0.2&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.4<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000002<br />&nbsp;&nbsp;Checksum:&nbsp;0x8D64<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;1<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;0.0.0.0<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;65001</pre><p></p>
<p class="codecaption">IP Routing Table on C1</p>
<pre class="code">C1#show&nbsp;ip&nbsp;route&nbsp;192.168.0.2<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.0.2/32<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;1<br />&nbsp;&nbsp;Tag&nbsp;65001,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;1<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.128.6&nbsp;on&nbsp;GigabitEthernet0/2,&nbsp;00:00:47&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.128.6,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:00:47&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;1,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;tag&nbsp;65001<br />&nbsp;&nbsp;*&nbsp;10.0.128.1,&nbsp;from&nbsp;192.168.0.1,&nbsp;00:01:01&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;1,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;tag&nbsp;65001</pre><p>Time for <a href="http://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">another MacGyver stunt</a>: </p>
<ul class="ListParagraph"><li>Enable OSPF on the (external) Metro Ethernet LAN that connects our OSPF network with a third-party router (yes, it&#x2019;s a Really Bad Idea from the security perspective);</li>
<li>Set OSPF costs (or bandwidth) correctly;</li>
<li>Hope that ASBRs start advertising Forwarding Address in Type-5 LSA and route selection of internal OSPF routes makes sure only the faster path is used. </li>
</ul>
<div class='separator'><a href="https://3.bp.blogspot.com/-FU4RDmeYMns/WIRjzTQtDqI/AAAAAAAAIuA/62U5kB-CdLMx8e2xJF28uZstvZne-Y0twCLcB/s1600/OSPF_FA_BW_2.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-FU4RDmeYMns/WIRjzTQtDqI/AAAAAAAAIuA/62U5kB-CdLMx8e2xJF28uZstvZne-Y0twCLcB/s550/OSPF_FA_BW_2.png" /></a></div>
<p>It actually works:</p>
<p class="codecaption">IP Routing Table on C1 after enabling OSPF on external subnet</p>
<pre class="code">C1#show&nbsp;ip&nbsp;route&nbsp;192.168.0.2<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.0.2/32<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;1<br />&nbsp;&nbsp;Tag&nbsp;65001,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;2<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.128.1&nbsp;on&nbsp;GigabitEthernet0/1,&nbsp;00:01:13&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;*&nbsp;10.0.128.1,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:01:13&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;1,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;tag&nbsp;65001</pre><p class="more">If you want to reproduce the results, start with OSPF-Forwarding-Address-Bandwidth-Mismatch VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>.</p>
<p>We can also observe another <em>interesting </em>(as in <em>how the **** did we ever get here</em>) behavior:</p>
<ul class="ListParagraph"><li>While both ASBRs advertised the Type-5 LSA before, after enabling OSPF on the external interface only one of them advertises Type-5 LSA</li>
</ul>
<p class="codecaption">Type-5 LSA is advertised only by E2</p>
<pre class="code">C1#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.3)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;272<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.0.2&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.4<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000003<br />&nbsp;&nbsp;Checksum:&nbsp;0x16CE<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;1<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;10.0.0.2<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;65001</pre><ul class="ListParagraph"><li>In our network the Type-5 LSA is advertised by the ASBR that is never used for packet forwarding toward the external destination (I am positive there&#x2019;s a section somewhere in <a href="https://tools.ietf.org/html/rfc2328">OSPF RFC</a> talking about higher ASBR router ID).</li>
</ul>
<p>Hooray, we just saved the memory occupied by one Type-5 LSA, and yet again increased the complexity of the protocol.</p>
<p class="info">Not only is this behavior fun to troubleshoot, try figuring out what happens when E2 crashes resulting in loss of light on P2P links but no detectable change on Metro Ethernet side. I have a wonderful explanation, but the <a href="https://en.wikipedia.org/wiki/Fermat's_Last_Theorem">margins of this blog post are not wide enough for it</a>, so it&#x2019;s <a href="http://catb.org/jargon/html/E/exercise--left-as-an.html">left as an exercise for the reader</a>.</p>
<p>Guess what: we didn&#x2019;t need OSPF FA in the first place. The correct design would be to increase OSPF external metrics on E2, and use External Type 1 (E1) metrics so that the other OSPF routers would consider total cost (internal + external) toward the external destinations. Alas, that&#x2019;s not how real-life problems are solved (at least not in the CCIE lab).</p>

