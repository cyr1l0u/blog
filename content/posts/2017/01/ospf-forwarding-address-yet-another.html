---
title: "OSPF Forwarding Address: Yet another Kludge"
date: "2017-01-19T09:06:00.000+01:00"
tags: [ OSPF ]
---

<p>One of my readers sent me an interesting NSSA question (more in a future blog post) that sent me chasing for the reasons behind the OSPF Forwarding Address (FA) field in type-5 and type-7 LSAs.</p>
<p>This is the typical scenario for OSPF FA I was able to find on the Internet:<!--more--></p>
<div class='separator'><a href="https://2.bp.blogspot.com/-DSLsvEG2ti4/WHssFPLzBlI/AAAAAAAAItg/dL7J1F9wEPMjGpe-Qtb0m_cTtoxtj139QCLcB/s1600/OSPF_FA_1.png" imageanchor="1" ><img border="0" src="https://2.bp.blogspot.com/-DSLsvEG2ti4/WHssFPLzBlI/AAAAAAAAItg/dL7J1F9wEPMjGpe-Qtb0m_cTtoxtj139QCLcB/s500/OSPF_FA_1.png" /></a></div>
<p>Two OSPF ASBRs are connected to the same external network, but only one of them is running the external routing protocol (BGP in my diagram) and redistributing external prefixes into OSPF. You&rsquo;d want to send the traffic toward external destinations through both ASBRs, but can&rsquo;t do that as only one of the ASBRs advertises the external routes.</p>
<p>Here are the relevant parts for E1 and E2 configuration:</p>
<p class="codecaption">OSPF and BGP configuration on E1</p>
<pre class="code">interface&nbsp;Loopback0<br />&nbsp;description&nbsp;Loopback<br />&nbsp;ip&nbsp;address&nbsp;192.168.0.1&nbsp;255.255.255.255<br />&nbsp;ip&nbsp;ospf&nbsp;1&nbsp;area&nbsp;1<br />!<br />interface&nbsp;GigabitEthernet0/1<br />&nbsp;description&nbsp;to&nbsp;C1<br />&nbsp;ip&nbsp;address&nbsp;10.0.128.1&nbsp;255.255.255.252<br />&nbsp;ip&nbsp;ospf&nbsp;1&nbsp;area&nbsp;1<br />&nbsp;ip&nbsp;ospf&nbsp;cost&nbsp;1<br />!<br />interface&nbsp;GigabitEthernet0/2<br />&nbsp;description&nbsp;to&nbsp;External_LAN<br />&nbsp;ip&nbsp;address&nbsp;10.0.0.1&nbsp;255.255.128.0<br />!<br />router&nbsp;ospf&nbsp;1<br />&nbsp;redistribute&nbsp;bgp&nbsp;65000&nbsp;subnets<br />&nbsp;passive-interface&nbsp;Loopback0<br />!<br />router&nbsp;bgp&nbsp;65000<br />&nbsp;bgp&nbsp;log-neighbor-changes<br />&nbsp;redistribute&nbsp;ospf&nbsp;1<br />&nbsp;neighbor&nbsp;10.0.0.2&nbsp;remote-as&nbsp;65001</pre><p></p>
<p class="codecaption">OSPF configuration on E2</p>
<pre class="code">interface&nbsp;Loopback0<br />&nbsp;description&nbsp;Loopback<br />&nbsp;ip&nbsp;address&nbsp;192.168.0.4&nbsp;255.255.255.255<br />&nbsp;ip&nbsp;ospf&nbsp;1&nbsp;area&nbsp;1<br />!<br />interface&nbsp;GigabitEthernet0/1<br />&nbsp;description&nbsp;to&nbsp;C1<br />&nbsp;ip&nbsp;address&nbsp;10.0.128.6&nbsp;255.255.255.252<br />&nbsp;ip&nbsp;ospf&nbsp;1&nbsp;area&nbsp;1<br />&nbsp;ip&nbsp;ospf&nbsp;cost&nbsp;1<br />!<br />router&nbsp;ospf&nbsp;1</pre><p class="note">BGP (and redistribution into OSPF) is configured on E1 but not on E2.</p>
<p>And here&rsquo;s the relevant part of the OSPF topology database. The prefix 192.168.0.2/32 that is advertised by X1 over EBGP is redistributed as type-5 LSA into OSPF by E1 (192.168.0.1)</p>
<p class="codecaption">Type-5 LSA in OSPF topology database</p>
<pre class="code">C1#show&nbsp;ip&nbsp;ospf&nbsp;database&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.3)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;301<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.0.2&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.1<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0xA154<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;1<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;0.0.0.0<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;65001</pre><p class="more">If you want to reproduce the results, download the VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>.</p>
<p>Enter the YAK (Yet Another Kludge) twilight zone: what if the ASBR advertises external next hop (forwarding address) in the type-5 LSA, and both ASBRs advertise the external prefix (hopefully as a stub network)? Recursive next-hop lookup would solve the problem and C1 would get two equal-cost routes toward the external destinations.</p>
<p>To enable this functionality E1 and E2 have to advertise the external subnet as an internal OSPF route, so we&rsquo;ll add the external interface to the OSPF process on E1 and E2.</p>
<p class="codecaption">Enabling OSPF on external interface on E1 and E2</p>
<pre class="code">interface&nbsp;GigabitEthernet0/2<br />&nbsp;description&nbsp;to&nbsp;External_LAN<br />&nbsp;ip&nbsp;ospf&nbsp;cost&nbsp;1</pre><p class="warn">You cannot make the external interface passive (= stub network). At least the recent versions of Cisco IOS do not set a forwarding address if the next-hop is on a passive interface; the external network must be a fully-functional OSPF interface. I was not able to find any relevant requirements in RFC 2328 &ndash; I probably missed something, if anyone knows more details, please write a comment.</p>
<p>After the configuration change the Type-5 LSA in the OSPF topology database gets the <em>forwarding address </em>value and C1 gets two equal-cost paths to the external destination.</p>
<p class="codecaption">Type-5 LSA with Forwarding Address field set to external next hop</p>
<pre class="code">C1&gt;show&nbsp;ip&nbsp;ospf&nbsp;database&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.3)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;907<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.0.2&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.1<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0x2CBD<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />MTID:&nbsp;0<br />Metric:&nbsp;1<br />Forward&nbsp;Address:&nbsp;10.0.0.2<br />External&nbsp;Route&nbsp;Tag:&nbsp;65001</pre><p></p>
<p class="codecaption">Two equal-cost routes to external destination</p>
<pre class="code">C1&gt;show&nbsp;ip&nbsp;route&nbsp;192.168.0.2<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.0.2/32<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;1<br />&nbsp;&nbsp;Tag&nbsp;65001,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;2<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.128.6&nbsp;on&nbsp;GigabitEthernet0/2,&nbsp;00:15:21&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.128.6,&nbsp;from&nbsp;192.168.0.1,&nbsp;00:15:21&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;1,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;tag&nbsp;65001<br />&nbsp;&nbsp;*&nbsp;10.0.128.1,&nbsp;from&nbsp;192.168.0.1,&nbsp;00:15:21&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;1,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;tag&nbsp;65001</pre><p>Problem solved? <strong>NO, OF COURSE NOT</strong>. You just made it worse:</p>
<ul class="ListParagraph"><li>Even though it looks like everything works as expected, E1 is a single point of failure &ndash; if it crashes, you lose route redistribution, and thus connectivity to external destinations;</li>
<li>The already-too-complex link-state routing protocol got another hard-to-figure-out quirk. See the <em>passive interface </em>gotcha above, and check all the complications T5 FA caused in OSPF route selection process (<a href="https://tools.ietf.org/html/rfc2328">RFC 2328</a>);</li>
<li>You have to run OSPF on the external interface (at least with recent Cisco IOS releases) to make this kludge work. Not exactly the most secure design I&rsquo;ve seen in my life (and please don&rsquo;t even mention that you could use an ACL to filter incoming OSPF packets on the external interface before <a href="http://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">reading this blog post</a>).</li>
</ul>
<p>The proper design would be to run external routing protocol and route redistribution on both ASBRs (yeah, I know, the beauties of two-way redistribution), and tell everyone who complained about this <em>deficiency </em>of OSPF to get lost and fix his design. </p>
<p>Alas, that&rsquo;s not how <a href="https://xkcd.com/927/">standards are made</a>. No wonder academics are making fun of the complexities of distributed routing protocols (and <a href="https://www.sdxcentral.com/articles/news/scott-shenker-preaches-revised-sdn-sdnv2/2014/10/">backpedaling on their own ridiculous claims</a>), and we&rsquo;re continuously involved in <a href="http://sethgodin.typepad.com/seths_blog/2005/03/dont_shave_that.html">YAK shaving</a> exercises.</p>
<p>Oh, and just because we got this wonderful unnecessary knob in OSPF, <a href="http://www.cisco.com/c/en/us/support/docs/ip/open-shortest-path-first-ospf/25493-type5-lsa.html">debugging OSPF became even more interesting</a>. Hooray!</p>

