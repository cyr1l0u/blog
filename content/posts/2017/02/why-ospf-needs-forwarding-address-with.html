---
title: "Why OSPF Needs Forwarding Address with NSSA Areas"
date: "2017-02-02T08:24:00.000+01:00"
tags: [ OSPF ]
---

<p>In the previous blog posts I described how <a href="http://blog.ipspace.net/2017/01/ospf-forwarding-address-yet-another.html">OSPF tries to solve some broken designs</a> with Forwarding Address field in Type-5 LSA &ndash; a <a href="http://blog.ipspace.net/2017/01/ospf-forwarding-address-yak-take-2.html">kludge that unnecessarily increases the already too-high complexity of OSPF</a>.</p>
<p>NSSA areas make the whole thing worse: OSPF needs Forwarding Address in Type-5 LSAs generated from Type-7 LSAs to ensure optimal packet forwarding. Here&#x2019;s why:<!--more--></p>
<p class='update'>Update 2017-02-06: Added a few more nerd knobs suggested by Angelos Vassiliou.</p>
<p>Let&#x2019;s start with a small (slightly) broken network:</p>
<ul class="ListParagraph"><li>Core router (C1) is in area 0;</li>
<li>Edge router (E1) is in NSSA area 1;</li>
<li>ABRs A1 and A2 connect edge network with core network.</li>
</ul>
<div class='separator'><a href="https://4.bp.blogspot.com/-hQ7AVri3B64/WI2YiTEGWaI/AAAAAAAAIu4/5GpzFrcKP8I1ZbwNvhdS_bKLxnnkjLnQACLcB/s1600/OSPF_NSSA_1.png" imageanchor="1" ><img border="0" src="https://4.bp.blogspot.com/-hQ7AVri3B64/WI2YiTEGWaI/AAAAAAAAIu4/5GpzFrcKP8I1ZbwNvhdS_bKLxnnkjLnQACLcB/s500/OSPF_NSSA_1.png" /></a></div>
<p class="warn">Whenever you have multiple ABRs connected to the same set of OSPF areas, you SHOULD have a link between them within each area <strong>and </strong>within the backbone area. The proof is left as an exercise for the reader. Note: you can implement the backbone link as a virtual link if the non-backbone area is not a stub/NSSA area.</p>
<p>Due to the way OSPF NSSA feature is designed:</p>
<ul class="ListParagraph"><li>Edge router (E1) redistributes an external subnet (192.168.1.0/24) into OSPF NSSA area as Type-7 LSA;</li>
<li>ABRs translate Type-7 LSAs into Type-5 LSAs;</li>
<li>Only one of the ABRs advertises Type-5 LSA into the backbone area (because whatever &ndash; details in <a href="https://tools.ietf.org/html/rfc3101">RFC 3101</a>).</li>
</ul>
<p class="codecaption">Backbone Type-5 LSA generated from Type-7 LSA</p>
<pre class="code">A1#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.1)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;113<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.4<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0x530A<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />MTID:&nbsp;0<br />Metric:&nbsp;20<br />Forward&nbsp;Address:&nbsp;192.168.0.2<br />External&nbsp;Route&nbsp;Tag:&nbsp;0</pre><p>Without the forwarding address in Type-5 LSA originated by A2 (in our sample network) C1 couldn&#x2019;t use both equal-cost paths toward E1 (C1-A1-E1 and C1-A2-E1); all the traffic would go through the ABR originating the Type-5 LSA. </p>
<p>How does the ABR figure out what forwarding address to use in Type-5 LSA translated from Type-7 LSA? It has no idea and shifts the problem to someone else (see also <a href="https://tools.ietf.org/html/rfc1925">RFC 1925</a> rule 6) &ndash; it uses whatever forwarding address is specified in Type-7 LSA.</p>
<p><strong>Corollary:</strong> Type-7 LSA MUST have a Forwarding Address.</p>
<p class="codecaption">Type-7 LSA originated by E1</p>
<pre class="code">A1#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;nssa-external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.1)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />Type-7&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States&nbsp;(Area&nbsp;1)<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;90<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;Type&nbsp;7/5&nbsp;translation,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.2<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0xCA8A<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />MTID:&nbsp;0<br />Metric:&nbsp;20<br />Forward&nbsp;Address:&nbsp;192.168.0.2<br />External&nbsp;Route&nbsp;Tag:&nbsp;0</pre><p>When a NSSA ASBR cannot use the real external next hop as the forwarding address, it usually uses the loopback address (that&#x2019;s why the forwarding address in the previous printout is set to 192.168.0.2), resulting in perfect ECMP behavior on C1:</p>
<p class="codecaption">C1 has two equal-cost paths to external destinations behind E1</p>
<pre class="code">C1#show&nbsp;ip&nbsp;route&nbsp;192.168.1.0<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.1.0/24<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;20,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;3<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.0.13&nbsp;on&nbsp;GigabitEthernet0/2,&nbsp;00:23:35&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.0.13,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:23:35&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;20,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1<br />&nbsp;&nbsp;*&nbsp;10.0.0.9,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:23:35&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/1<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;20,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1</pre><p class="more">If you want to reproduce the results, start with OSPF-NSSA-Forwarding-Address VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>.</p>
<p>Now let&#x2019;s see what happens if we shut down the loopback interface on E1 (or remove it from the OSPF process), placing E1 under considerable stress:</p>
<ul class="ListParagraph"><li>It cannot use the real external next hop (because the next hop subnet is not advertised into OSPF);</li>
<li>It doesn&#x2019;t have a usable loopback address advertised as an internal OSPF route.</li>
</ul>
<p>E1 consequently takes one of its other IP addresses (I&#x2019;m positive RFC 3101 goes into great details which one to use, but I couldn&#x2019;t be bothered with those details) and uses it as the forwarding address. In our case, E1 chose the IP address on the E1-A2 link.</p>
<p class="codecaption">E1 uses internal OSPF subnet as a forwarding address</p>
<pre class="code">A1#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.1)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;25<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.4<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000002<br />&nbsp;&nbsp;Checksum:&nbsp;0x703B<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;20<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;10.0.0.18<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;0</pre><p>The change of forwarding address breaks load sharing on C1 as the subnet specified in the forwarding address is no longer reachable over two equal-cost paths. C1 sends all the traffic toward E1 over A2.</p>
<p class="codecaption">C1 has a single path toward external destination behind E1</p>
<pre class="code">C1#show&nbsp;ip&nbsp;route&nbsp;192.168.1.0<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.1.0/24<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;20,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;2<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.0.13&nbsp;on&nbsp;GigabitEthernet0/2,&nbsp;00:29:09&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;*&nbsp;10.0.0.13,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:29:09&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;20,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1</pre><p>Hooray, we broke OSPF (again).</p>
<h4>But wait, it gets worse&hellip;</h4><p>Igor Osadchuk sent me this tidbit:</p>
<blockquote class='cite'>The interesting thing about FA is that since it is used in a recursive lookup and OSPF effectively acts as a distance vector protocol in this case, FA address has to be present in a RIB (and ultimately in a FIB) or external prefix won't be resolved. Fun to troubleshoot! </blockquote>
<h4>Even more nerd knobs</h4><p>Angelos Vassiliou sent me an email pointing out that we could use <strong>area 1 nssa translate type7 always</strong> to force both ABRs to originate type-5 LSAs. This would solve some edge cases resulting from discontiguous NSSA area, but would not solve our problem.</p>
<p>There's another nerd knob (that in my understanding violates the NSSA RFC): <strong>area nssa translate type7 supress-fa</strong> would suppress FA information in type-5 LSA originating into the backbone, potentially resulting in ECMP within the backbone, but not in correct end-to-end ECMP in scenarios with unequal-cost links.</p>
<h4>Do we really have to deal with all this complexity?</h4><p>Probably not. After all, my calendar claims it&#x2019;s 2017, and most routers ship with reasonably fast CPUs and gigabytes of memory these days. Here&#x2019;s what you could do to make your life simpler:</p>
<ul class="ListParagraph"><li>If you have low hundreds of routers and don&#x2019;t care too much about the impact of convergence/SPF events use a single OSPF area;</li>
<li>If you&#x2019;re wondering whether OSPF can survive a few hundred routers in the same area, use IS-IS for your next design;</li>
<li>If your network is larger than that (or you don&#x2019;t feel comfortable pushing OSPF to its limits) use BGP at the edges and OSPF in the core;</li>
<li>If your vendor tries to charge you extra for the privilege of using BGP tell them it&#x2019;s 2017 and vote with your wallet (aka <em>Change the Vendor</em>).</li>
</ul>
<p>You can also use me for a <a href="http://www.ipspace.net/ExpertExpress">short online consulting session</a> to discuss these challenges or validate your design.</p>

