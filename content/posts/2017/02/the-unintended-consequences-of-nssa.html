---
title: "The Unintended Consequences of NSSA Kludges"
date: "2017-02-09T10:39:00.000+01:00"
tags: [ Design,OSPF ]
---

<p>Remember the <a href="http://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">kludges needed to make OSPF NSSA areas work correctly</a>? We concluded that saga by showing how the rules of RFC 3101 force a poor ASBR to choose an IP address on one of its OSPF-enabled interfaces as a forwarding address to be used in Type-7 LSA. </p>
<p>What could possibly go wrong with such a &ldquo;simple&rdquo; concept?<!--more--></p>
<p>Let&#x2019;s start with the network we used in the <a href="http://blog.ipspace.net/2017/02/why-ospf-needs-forwarding-address-with.html">previous blog post</a>. In the end of that blog post we shut down the loopback interface on E1 to force it to select something else as the Type-7 LSA forwarding address. While that resulted in suboptimal traffic flow, we could still ping 192.168.1.1 (IP address on a non-OSPF loopback interface on E1) from C1.</p>
<div class='separator'><a href="https://4.bp.blogspot.com/-aaKIQP-BVVE/WJbwlVMP5oI/AAAAAAAAIvg/hXLCka5xZSgK8q71bUDn6le4EmB78qKmgCLcB/s1600/OSPF_NSSA_2.png" imageanchor="1" ><img border="0" src="https://4.bp.blogspot.com/-aaKIQP-BVVE/WJbwlVMP5oI/AAAAAAAAIvg/hXLCka5xZSgK8q71bUDn6le4EmB78qKmgCLcB/s550/OSPF_NSSA_2.png" /></a></div>
<p>Now let&#x2019;s pretend the interface E1 chose is a Metro Ethernet link and it just failed in one of those mysterious ways where everything seems OK but no packets make it across the link. We&#x2019;ll emulate this too-well-known behavior (never a Service Provider fault if you ask them) with an incoming <strong>deny ip any any </strong>access list.</p>
<p class="note">Service Providers are more thorough &ndash; they&#x2019;d also drop ARP packets and everything else, but this ACL will do for our purposes. </p>
<p>To make the fault look even more like a Metro Ethernet network, we&#x2019;ll install the ACL only on E1 side of A2E1 link, resulting in a unidirectional link. As expected, the OSPF adjacency between A2 and E1 goes down. Totally unexpected, C1 can no longer ping external subnets on E1 <em>even though there&#x2019;s a perfectly good path from C1 to E1.</em></p>
<p class="codecaption">C1 has the destination in its routing table</p>
<pre class="code">C1#show&nbsp;ip&nbsp;route&nbsp;192.168.1.0<br />Routing&nbsp;entry&nbsp;for&nbsp;192.168.1.0/24<br />&nbsp;&nbsp;Known&nbsp;via&nbsp;"ospf&nbsp;1",&nbsp;distance&nbsp;110,&nbsp;metric&nbsp;20,&nbsp;type&nbsp;extern&nbsp;2,&nbsp;forward&nbsp;metric&nbsp;2<br />&nbsp;&nbsp;Last&nbsp;update&nbsp;from&nbsp;10.0.0.13&nbsp;on&nbsp;GigabitEthernet0/2,&nbsp;00:29:09&nbsp;ago<br />&nbsp;&nbsp;Routing&nbsp;Descriptor&nbsp;Blocks:<br />&nbsp;&nbsp;*&nbsp;10.0.0.13,&nbsp;from&nbsp;192.168.0.4,&nbsp;00:29:09&nbsp;ago,&nbsp;via&nbsp;GigabitEthernet0/2<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Route&nbsp;metric&nbsp;is&nbsp;20,&nbsp;traffic&nbsp;share&nbsp;count&nbsp;is&nbsp;1</pre><p class="codecaption">Pings return <em>destination unreachable </em>ICMP replies</p>
<pre class="code">C1&gt;ping&nbsp;192.168.1.1<br />Type&nbsp;escape&nbsp;sequence&nbsp;to&nbsp;abort.<br />Sending&nbsp;5,&nbsp;100-byte&nbsp;ICMP&nbsp;Echos&nbsp;to&nbsp;192.168.1.1,&nbsp;timeout&nbsp;is&nbsp;2&nbsp;seconds:<br />U.U.U<br />Success&nbsp;rate&nbsp;is&nbsp;0&nbsp;percent&nbsp;(0/5)</pre><p class="more">If you want to reproduce the results, start with OSPF-NSSA-Forwarding-Address VIRL topology from my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a> and add the incoming ACL Gi0/2 interface on E1.</p>
<h4>Wait, what?</h4><p>Let&#x2019;s trace the path from C1 to E1. The routing entry for 192.168.1.0/24 on C1 points to A2, and A2 claims it doesn&#x2019;t know anything about 192.168.1.0/24. Confusing, right?</p>
<p class="codecaption">A2 doesn&#x2019;t know anything about 192.168.1.0</p>
<pre class="code">A2#show&nbsp;ip&nbsp;route&nbsp;192.168.1.0<br />%&nbsp;Network&nbsp;not&nbsp;in&nbsp;table</pre><p>Well, it turns out the broken link between A2 and E1 also broke the NSSA area in two parts, and A2 wouldn&#x2019;t consider the Type-7 LSA from E1 when running SPF as it has no intra-area connectivity to E1. </p>
<div class='separator'><a href="https://3.bp.blogspot.com/-EAi583k4z-g/WJby7kZRdsI/AAAAAAAAIvs/0dGVPW2dVXImDiBCwT6_j5LqYEqqK8npACLcB/s1600/OSPF_NSSA_3.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-EAi583k4z-g/WJby7kZRdsI/AAAAAAAAIvs/0dGVPW2dVXImDiBCwT6_j5LqYEqqK8npACLcB/s550/OSPF_NSSA_3.png" /></a></div>
<p class="codecaption">Type-7 LSA refers to an unreachable router ID and is thus ignored</p>
<pre class="code">A2#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;nssa-external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.4)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-7&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States&nbsp;(Area&nbsp;1)<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;1284<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;Type&nbsp;7/5&nbsp;translation,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.2<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;8000000C<br />&nbsp;&nbsp;Checksum:&nbsp;0xD3C5<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;20<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;10.0.0.18<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;0</pre><p>The packet from C1 arrives to A2, and A2 simply drops it (resulting in ICMP unreachables observed on C1).</p>
<p>Will the situation get any better when Type-7 LSA ages out on A2? Let&#x2019;s reset the OSPF process on A2 with the <strong>clear ip ospf process </strong>command. Type-7 LSA is gone, and A2 sees only the backbone Type-5 LSA but still refuses to install 192.168.1.0/24 into the forwarding table:</p>
<p class="codecaption">Type-5 LSA looks good, but is still not used</p>
<pre class="code">A2#show&nbsp;ip&nbsp;ospf&nbsp;data&nbsp;external<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.4)&nbsp;(Process&nbsp;ID&nbsp;1)<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;893<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.1<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0x842B<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />&nbsp;&nbsp;Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />&nbsp;&nbsp;MTID:&nbsp;0<br />&nbsp;&nbsp;Metric:&nbsp;20<br />&nbsp;&nbsp;Forward&nbsp;Address:&nbsp;10.0.0.18<br />&nbsp;&nbsp;External&nbsp;Route&nbsp;Tag:&nbsp;0</pre><p>It seems this behavior is a consequence of Rule #4 of Section 16.4 in <a href="https://tools.ietf.org/html/rfc2328">RFC 2328</a> (OSPF v2):</p>
<blockquote class="cite">If the forwarding address is non-zero, look up the forwarding address in the routing table. The matching routing table entry must specify an intra-area or inter-area path.</blockquote>
<p>Looks like a stub interface (OSPF-enabled interface with no neighbors on it) doesn&#x2019;t satisfy the <em>intra-area or inter-area path </em>criteria. A2 thus ignores the Type-5 LSA pointing to its directly connected interface.</p>
<h4>Nerd Knobs to Rescue</h4><p>The <strong>area nssa translate type7 always suppress-fa</strong><strong> </strong>nerd knob suggested by Angelos Vassiliou would solve this problem (because there would be no recursive lookup for the forwarding address) while at the same time violating paragraph (2) of <a href="#section-3.2">section 3.2 in RFC 3101</a>.</p>
<p class="note">You could argue that the ABR behaves like every type-7 LSA would be aggregated into a separate address range as described in paragraph (3) of the same section. I still have to check how Cisco IOS handles the costs of such type-5 LSA.</p>
<h4>The Really Sad Part</h4><p>I created at least one OSPF deep-dive course, and taught it at least a dozen of times (quite often having Cisco&#x2019;s TAC engineers in the audience), and I was still surprised to see this behavior.</p>
<h4>Summary</h4><p>OSPF is way too complex for its own good. If you must use OSPF get rid of as much of its complexity as you can&ndash; use a single area if at all possible, and stay away from NSSA areas.</p>

