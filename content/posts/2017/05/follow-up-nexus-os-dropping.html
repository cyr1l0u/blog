---
url: /2017/05/follow-up-nexus-os-dropping.html
title: "Follow-up: Nexus-OS Dropping Configuration Commands"
date: "2017-05-08T09:30:00.000+02:00"
---

<p>Not long after I published the <a href="http://blog.ipspace.net/2017/04/lets-drop-some-random-commands-shall-we.html"><em>let’s drop some configuration commands</em></a><em> </em>rant I got a very nice email from <a href="https://www.linkedin.com/in/nicolasdelecroix/">Nicolas Delecroix</a>, Technical Marketing Engineer in Cisco INSBU, effectively saying “<em>W</em><em>ould you have time for a short WebEx call to discuss the root cause of the problem and what we did to fix it</em>?”</p>
<p>Of course I agreed and here’s what they told me:<!--more--></p>
<ul class="ListParagraph"><li>They were able to reproduce the problem;</li>
<li>The drops were caused by a very old bug in Linux TTY device driver <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3a54297478e6578f96fd54bf4daa1751130aca86">introduced in 2009</a>, <a href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/1208740">discovered in Ubuntu ~4 years ago</a> and present in <a href="https://lkml.org/lkml/2013/7/25/205">all Linux distributions</a> with kernels between 2.6.31 and 3.11.0.</li>
</ul>
<p class="note">On Linux-based platforms the router configuration process is usually run as a regular process within a login shell, which means that the path your data has to take goes through ssh server, kernel TTY driver (to make SSH connection appears as just another VT100 terminal), and finally the user process.</p>
<ul class="ListParagraph"><li>The bug was sitting in NX-OS for years, but got more visible due to shift to model-based device configuration architecture that added some delay in the configuration path.</li>
<li>They couldn’t upgrade the Linux kernel used by Nexus-OS (currently 3.4.91) but backported the bug fix into TTY device driver used by Nexus-OS.</li>
<li>The fixed TTY driver will ship with Nexus OS releases 7.0(3)I6(1) and 7.0(3)I4(7). Nicholas told me they’re targeting to ship both releases before end of May.</li>
</ul>
<p>Now that we know what the problem is, it’s easy to figure out the workarounds. They recommended: </p>
<ul class="ListParagraph"><li>Copy configuration file to the device and then use <strong>copy </strong><strong><em>file </em></strong><strong>running-config</strong></li>
<li>Use NX-API</li>
</ul>
<p>These two should also work:</p>
<ul class="ListParagraph"><li>Use <strong>scp </strong><strong><em>file router</em></strong><strong>:running config </strong></li>
<li>Use an <strong>expect </strong>script that waits for prompt before sending the next command.</li>
</ul>
<p>Of course I had to snoop around a bit and found that:</p>
<ul class="ListParagraph"><li>The bug is easy to reproduce in <strong>bash </strong>and has nothing to do with router configuration.</li>
<li>The bug is causing large pastes (5K or more) to fail in any program that uses <strong>readline </strong>(the library that handles line editing) or anything similar, and is thus present on any server or network device running Linux with affected Linux kernel.</li>
<li>Unless a device vendor backported the fix into the Linux TTY driver they’re using (it seems Ubuntu developers decided to do this as well) every device running affected Linux kernel might experience the same behavior.</li>
</ul>
<p>If you’re running a network device that runs on top of a Linux kernel, it’s relatively easy to get the kernel version: go into shell, type <strong>uname –a</strong>… and let me know what you find out ;)</p>
<p>Finally, I’d like to thank again Nicholas and the Cisco INSBU engineers for an extremely professional approach to this problem.</p>

