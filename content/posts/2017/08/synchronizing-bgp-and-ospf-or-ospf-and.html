---
title: "Synchronizing BGP and OSPF (or OSPF and LDP)"
date: "2017-08-29T09:01:00.000+02:00"
tags: [ MPLS,OSPF,BGP,IP routing ]
---

<p>Rich sent me a question about temporary traffic blackholing in networks where every router is running IGP (OSPF or IS-IS) and iBGP. </p>
<p>He started with a very simple network diagram:<!--more--></p>
<pre class="code">            +------+    +------+<br/>    +-------+  C1  +----+  C2  +-------+<br/>    |       +------+    +------+       |<br/>+------+                            +------+<br/>|  E1  |                            |  E2  |<br/>+------+                            +------+<br/>    |       +------+    +------+       |<br/>    +-------+  C3  +----+  C4  +-------+<br/>            +------+    +------+</pre><p>The routers are configured as follows:</p>
<ul class="ListParagraph"><li>The network does not have a default route;</li>
<li>All routers run OSPF and iBGP;</li>
<li>iBGP sessions are established between loopback interfaces;</li>
<li>E1 and E2 insert external prefixes into iBGP;</li>
<li>BGP next hop is not changed across the autonomous system;</li>
<li>There’s a full mesh of iBGP sessions between the routers, or a route reflector somewhere – doesn’t really matter;</li>
</ul>
<p>Now imagine C1 crashes. No problem. IGP detects the topology change, and changes the IP routing tables accordingly. BGP next hop is unchanged, so there’s no need for BGP convergence. Life is good.</p>
<p>A few minutes later C1 recovers. IGP establishes adjacencies between C1 and its neighbors. BGP sessions are established only after IGP already changed the routing tables (C1’s loopback was not reachable prior to that), and it takes a while for C1 to populate its BGP table and copy its contents into its routing table.</p>
<p>In the meantime, E1 sees two equal-cost paths toward E2 and starts sending traffic toward external destinations to C1, which immediately drops it, resulting in a temporary traffic black hole until C1 receives all the BGP updates and installs BGP prefixes into its IP routing and forwarding tables.</p>
<p class="warn">You’ll experience the same problem any time you’re trying to use functionality (IP forwarding) that relies on information supplied by two independent eventually-consistent systems (OSPF and BGP). <a href="http://blog.ipspace.net/2011/11/ldp-igp-synchronization-in-mpls.html">MPLS forwarding using LDP exhibits very similar behavior</a>; see also <a href="http://blog.ipspace.net/2008/02/use-slow-igp-startup-in-ldp-only-mpls.html">this blog post</a>.</p>
<p>Rich’s question: how can I fix that?</p>
<p>As always, it depends. The “canonical” answer (probably expected in the CCIE lab) is <strong>max-metric router-lsa on-startup wait-for-bgp</strong> OSPF router configuration command (there’s a similar command for IS-IS).</p>
<p>The <strong>max-metric router-lsa </strong>command makes a router advertise its Type-1 (router) LSA with maximum metric allowed by OSPF, making paths through it less preferred than anything else. The <strong>on-startup </strong>option tells the router to do that <em>after reload </em>(instead of immediately) and the next parameter tells the router how long it should advertise the maximum metric – you can specify it in seconds or tell the OSPF routing process to wait for BGP to converge (or at most 10 minutes).</p>
<p>The interesting question at this point should be: <em>and how does the router know when the BGP routing process has converged? </em>The Cisco IOS XE documentation is totally mum on the topic, but I remember seeing something along the lines of <em>we assume BGP has converged when we receive a BGP keepalive message from all peers (which means they have nothing more to tell us</em>).</p>
<p>And now for the fun answers:</p>
<ul class="ListParagraph"><li>Turn the BGP+OSPF synchronization challenge into a LDP+OSPF synchronization challenge by deploying MPLS forwarding in BGP-free core. See also RFC 1925 rule 6.</li>
<li>Build a BGP-only network. Not necessarily a good idea if you care about convergence times and your network is not highly symmetrical. The proof is left as an exercise for the reader.</li>
<li>Use BGP-free core with MPLS forwarding based on segment routing instead of LDP.</li>
</ul>
<p>Want to know more? Explore the <a href="http://www.ipspace.net/Segment_Routing_Introduction">Segment Routing 101 webinar</a>.</p>
<p>Have a similar problem? I’m available for <a href="http://www.ipspace.net/ExpertExpress">short consulting sessions</a>.</p>
<p>Want to automate your network? There’s a <a href="http://www.ipspace.net/Building_Network_Automation_Solutions">course that might help you</a>.</p>
<p>Looking for sample Ansible playbooks? Here’s an <a href="https://github.com/ipspace/ansible-examples/tree/master/OSPF-Deployment">OSPF one</a>, and here’s an <a href="https://github.com/ipspace/MPLS-infrastructure">OSPF+BGP+MPLS+Inter-AS</a> one.</p>

