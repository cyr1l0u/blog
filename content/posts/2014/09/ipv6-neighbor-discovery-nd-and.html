---
title: "IPv6 Neighbor Discovery (ND) and Multicast Listener Discovery (MLD) Challenges"
date: "2014-09-10T07:20:00.000+02:00"
tags: [ IPv6,LAN ]
---

<p>A few days ago <a href="http://bimajority.org/~wollman/">Garrett Wollman</a> published his <a href="http://blog.bimajority.org/2014/09/05/the-network-nightmare-that-ate-my-week/">exasperating experience running IPv6 on large L2 subnets with Juniper Ex4200 switches</a>, concluding that &ldquo;<em>&hellip; much in IPv6 design and implementation has been botched by protocol designers and vendors &hellip;</em>&rdquo; (some of us would forcefully agree) making IPv6 &ldquo;<em>&hellip;simply unsafe to run on a production network&hellip;</em>&rdquo;</p>
<p>The <a href="https://news.ycombinator.com/item?id=8278864">resulting debate on Hacker News</a> is quite interesting (and <a href="https://twitter.com/ayourtch">Andrew Yourtchenko</a> is trying hard to keep it close to facts) and definitely worth reading&hellip; but is ND/MLD really as broken as some people claim it is?<!--more--></p>
<h4>What? What multicast?</h4><p>Just in case you&#x2019;re not familiar with the intricate details of IPv6: MLD stands for Multicast Listener Discovery, and if you want to ask, &ldquo;why do I need multicast to get neighbor discovery&rdquo;, you&#x2019;re not alone. After all, ARP in IPv4 works quite well with broadcast MAC address&hellip; or so people think until they&#x2019;re faced with a reality of a broadcast storm on an oversized IPv4 subnet.</p>
<p class="note">I&#x2019;ve heard of people running 10K+ hosts in the same subnet. Let&#x2019;s be diplomatic and say that they&#x2019;re somewhat stretching the design limits of Ethernet and IPv4.</p>
<p>IPv6 protocol designers tried to solve the problem of every host on the subnet getting involved in ARP processing by using a range of L2+L3 multicast groups. IPv6 address is hashed into a multicast IPv6 address (which is further cached into a multicast MAC address), and the ND queries (ARP requests in IPv4 lingo) are sent to the IPv6 multicast/MAC multicast address associated with the target IPv6 address, instead of broadcast MAC address. You&#x2019;ll find more details in <a href="http://tools.ietf.org/html/rfc4861">RFC 4861</a> and in my <a href="http://www.ipspace.net/Building_Large_IPv6_Access_Networks">IPv6 webinars</a>.</p>
<p>In a properly designed network with properly implemented host stacks using NICs that are capable of hardware-based multicast filters, the idea actually reduces the unnecessary load on the end-hosts.</p>
<p class="note">You did notice the many conditionals in the previous paragraph, did you?</p>
<p>Going a step further, the protocol designers tried to reduce the link load on switched L2 networks &ndash; MLD snooping (almost identical to IGMP snooping) allows L2 switches to optimize the distribution tree for multicast MAC addresses, delivering the ND queries only to the hosts that expect them (without MLD snooping, the ND queries are delivered to all hosts and filtered out by NIC).</p>
<p>If you want MLD snooping to work, you obviously have to prompt the hosts to report what they expect to receive &ndash; an IPv6 router attached to a L2 subnet has to generate periodic MLD queries to help the L2 switches discover multicast-enabled end hosts.</p>
<h4>What went wrong?</h4><p>It&#x2019;s hard to figure out what exactly went wrong with the CSAIL network, because we&#x2019;re probably lacking loads of details, but there are a few easy conclusions to make:</p>
<ul class="ListParagraph"><li>A design with numerous VLANs spread all over the place and connected to a single set of L3 switches is a <a href="http://blog.ipspace.net/2012/05/layer-2-network-is-single-failure.html">single failure domain</a> (I couldn&#x2019;t resist writing this down);</li>
<li>Don&#x2019;t blame the protocol if your vendor lacks feature parity on pretty baseline features, or is late in implementing them. Several comments on the original article mentioned using DHCPv6 to get rid of multiple IPv6 privacy addresses per host, but of course you need a working DHCPv6 relay for that;</li>
<li>Don&#x2019;t blame the protocol when you hit implementation bugs;</li>
<li>IPv6 deployment is like any other major new technology deployment: do a proper design, run a pilot project, and then gradually deploy the new technology (expecting some hiccups on the way). Everyone who attended my <a href="http://www.ipspace.net/IPv6E101">Enterprise IPv6 101 webinar</a> is well aware of that ;) </li>
<li>Don&#x2019;t expect to just turn on IPv6 if you&#x2019;re already stretching the limits of your existing technologies or your gear (see also <a href="http://www.ietf.org/mail-archive/web/v6ops/current/msg19890.html">this email</a> if you need a hefty dose of sarcasm).</li>
<li>Expect to do some tuning when implementing designs that are outside of the &ldquo;normal&rdquo; usage (for whatever value of &ldquo;normal&rdquo;). You wouldn&#x2019;t expect to run 1000 routers in an OSPF area without some heavy Tuning-Fu, would you?</li>
<li>Older platforms with $0.02 CPUs might get overloaded when processing MLD replies (assuming I understand the numbers from the blog post correctly, EX4200 experienced problems at around 300 MLD replies per second);</li>
<li>Control-plane protection (CoPP) - assuming it works for IPv6 on your platform - is there for a reason;</li>
<li>CPU overload (or any other control-plane glitch) <a href="http://blog.ipspace.net/2014/07/is-stp-really-evil.html">will result in STP breakdown</a> and forwarding loops (hint: MLAG might help &ndash; at least you won&#x2019;t get the forwarding loops);</li>
<li>Check the table sizes of your switches during your IPv6 readiness audit (you did plan to do an audit before deploying IPv6, did you?). EX4200 is not one of the worst offenders &ndash; EX4500 and EX4550 have just 1K IPv6 ND entries (all three switches also have dismal IPv6 forwarding table sizes). </li>
</ul>
<p class="info">You&#x2019;ll find table sizes for most data center switches produced by major vendors (including EX-series from Juniper) in my <a href="http://www.ipspace.net/DCFabric">Data Center Fabrics</a> webinar.</p>
<p>On the topic of table sizes: </p>
<ul class="ListParagraph"><li>You do need ND entry in a L3 switch for every active address (active = communicating with the L3 switch) on every IPv6 host &ndash; that would be at least 2 addresses per host, and potentially many more due to the way some mobile devices implement privacy extensions;</li>
<li>You SHOULD NOT need an IPv6 multicast entry for every ND multicast group &ndash; after all, these groups are link-local, so there&#x2019;s no need for L3 switch to keep their state. </li>
<li>Likewise, you L2 switches SHOULD NOT use IPv6 entries (assuming they have them) for IPv6 multicast filters; as they&#x2019;re L2 switches, they should use the same multicast MAC forwarding hardware they use for IPv4 (or any other protocol).</li>
</ul>
<p class='note'>On a tangential note, I'm not claiming that the privacy addresses and numerous addresses per interface are the best idea ever. Likewise, I'm not exactly a fan of SLAAC in tightly-controlled enterprise networks, but these opinions aren't exactly relevant in the context of this blog post.</p>
<h4>Workarounds</h4><p>If everything else fails, it&#x2019;s time for a <a href="http://blog.ipspace.net/2013/08/temper-your-macgyver-streak.html">MacGyver stunt</a> (note: don&#x2019;t do this at home). If you&#x2019;re not using MLD snooping on L2 switches, there&#x2019;s no need for frequent MLD queries &ndash; change MLD query interval to whatever maximum value you can. </p>
<p>Also, if you don&#x2019;t use IPv6 multicast, I don't see any need to run MLD on the LAN &ndash; turn it off if you can&hellip; or maybe I'm missing something obvious, in which case please write a comment.</p>
<p class='more'>For more information on IPv6 multicast, ND and MLD, go through <a href="http://inconcepts.biz/~jsw/ipv6_nd_problems_with_l2_mcast.pdf">this presentation</a>. Also note that we wouldn't have this problem if we would use <a href="http://blog.ipspace.net/2014/06/why-is-ipv6-layer-2-security-so-complex.html">L3-only IPv6 forwarding</a>.</p>

