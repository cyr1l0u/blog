---
title: "Micro-BFD: BFD over LAG (Port Channel)"
date: "2014-10-20T07:15:00.000+02:00"
tags: [ Link aggregation,IP routing ]
---

<p>The discussion in the comments to my <a href="http://blog.ipspace.net/2014/10/lag-versus-ecmp.html"><em>LAG versus EC</em><em>M</em><em>P</em></a> post took a totally unexpected turn when someone mentioned BFD failure detection over port channels (link aggregation groups &ndash; LAGs).</p>
<p>What&#x2019;s the big deal?<!--more--></p>
<h4>What is BFD</h4><p>Bidirectional Forwarding Detection (BFD) is a lightweight protocol that &ldquo;<em>provides low-overhead, short-duration detection of failures in the path between adjacent forwarding engines</em>&rdquo; (straight from <a href="http://tools.ietf.org/html/rfc5880">RFC 5880</a>).</p>
<p>Networking engineers love BFD for several reasons:</p>
<ul class="ListParagraph"><li>It&#x2019;s simpler and less CPU-intensive than routing protocol adjacency messages;</li>
<li>It can be implemented in smart linecards, further reducing the control-plane CPU load, and making it possible to detect forwarding failures in milliseconds even on boxes with hundreds of interfaces (try doing that with OSPF);</li>
<li>It detects <a href="http://en.wikipedia.org/wiki/Byzantine_fault_tolerance">byzantine failures</a> between two forwarding engines that cannot be reliably detected at physical and data-link layers.</li>
</ul>
<p>BFD uses the principle of <a href="http://blog.ipspace.net/2014/08/fate-sharing-in-ip-networks.html"><em>shared fate</em></a><em> </em>to do its job &ndash; it tests the actual transmission path using the same protocol (IP) as the forwarded traffic &ndash; and thus reliably detects a forwarding failure in a simple transmission path, regardless of the number of components in the path.</p>
<div class='separator'><a href="http://1.bp.blogspot.com/-XXStjXe5Kyc/VDuy2jdCpHI/AAAAAAAAH9Y/qU51X3hDmpU/s1600/MicroBFD%2B-%2BSingle%2Blink.png" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-XXStjXe5Kyc/VDuy2jdCpHI/AAAAAAAAH9Y/qU51X3hDmpU/s500/MicroBFD%2B-%2BSingle%2Blink.png" /></a></div>
<h4>BFD and LAG</h4><p>LAG appears as a single layer-2 forwarding path to layer-3 forwarding engine. BFD messages can take any one of the links in the LAG (based on the LAG load balancing algorithm), breaking the <em>shared fate </em>assumption &ndash; a forwarded packet traversing another LAG member link might encounter a partially failed component, and it&#x2019;s impossible for BFD to detect that.</p>
<div class='separator'><a href="http://2.bp.blogspot.com/-2vgwvotwEWY/VDuy2oeaquI/AAAAAAAAH9c/wYr0Del6yqk/s1600/MicroBFD%2B-%2BBFD%2Bover%2BLAG.png" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-2vgwvotwEWY/VDuy2oeaquI/AAAAAAAAH9c/wYr0Del6yqk/s500/MicroBFD%2B-%2BBFD%2Bover%2BLAG.png" /></a></div>
<p>The only solution to this problem is to run BFD across <em>every </em>LAG member link &ndash; the BFD code has to become LAG-aware and test end-to-end connectivity across every member link independently (see <a href="http://tools.ietf.org/html/rfc7130">RFC 7130</a> for more details). Even more, LACP and BFD have to work in parallel &ndash; a member is added to a LAG only when both LACP and BFD agree it&#x2019;s OK to do so.</p>
<div class='separator'><a href="http://3.bp.blogspot.com/-hDjuv4idAoc/VDuy2vZStGI/AAAAAAAAH9U/Tn4zbXX4wd4/s1600/MicroBFD%2BSessions.png" imageanchor="1" ><img border="0" src="http://3.bp.blogspot.com/-hDjuv4idAoc/VDuy2vZStGI/AAAAAAAAH9U/Tn4zbXX4wd4/s500/MicroBFD%2BSessions.png" /></a></div>
<h4>Where can I get it?</h4><p>Micro-BFD is available in <a href="http://www.juniper.net/documentation/en_US/junos13.3/topics/concept/bfd-for-lag-overview.html">Junos release 13.3</a>, <a href="http://www.cisco.com/c/en/us/td/docs/switches/datacenter/nexus5500/sw/interfaces/6x/b_5500_Interfaces_Config_Guide_Release_6x/b_5500_Interfaces_Config_Guide_Release_6x_chapter_0110.html#concept_0B1573CB2DE248338D6EF32C62FC904D">Cisco Nexus OS</a> and Cisco <a href="http://www.cisco.com/c/en/us/td/docs/routers/crs/software/crs_r4-0/interfaces/configuration/guide/hc40crsbook/hc40bifw.pdf">IOS XR Release 4.0</a>. Any other implementation? Write a comment!</p>
<h4>More information</h4><p>I <a href="http://learning.nil.com/tips-and-tricks/technical-articles/show/improve-the-convergence-of-mission-critical-networks-with-bidirectional-forwarding-detection-bfd/">wrote about BFD</a> a long long time ago.</p>

