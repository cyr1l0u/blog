---
title: "MPLS ping and traceroute"
date: "2007-06-21T17:25:00.000+02:00"
tags: [ MPLS,network management ]
---

One of the hardest troubleshooting problems within an MPLS VPN network has always been finding a broken LSP. While you could (in theory) use the IP <strong>ping</strong> or <strong>traceroute</strong> (assuming all hops support ICMP extensions for MPLS), the results are not always reliable ... and interpreting them is not so easy. For example, after I've disabled LDP on an interface with the <strong>no mpls ip</strong> configuration command, the routers in the LSP path still reported outgoing MPLS labels in ICMP replies for a few seconds (until the LDP holddown timer expired on both ends of the link). As a side note, would you deduce from the printout that the break in the LSP path happened on the router with the IP address 192.168.201.1?<pre class="code">ro#<strong>trace ip 1.0.0.1</strong><br/>Tracing the route to 1.0.0.1<br/><br/>  1 192.168.201.1 [MPLS: Label 22 Exp 0] 204 msec 200 msec 212 msec<br/><span class="high">  2 192.168.201.6 [MPLS: Label 16 Exp 0] 112 msec 112 msec 116 msec</span><br/>  3 192.168.0.6 56 msec *  60 msec<br/>ro#<strong>trace ip 1.0.0.1</strong><br/>Tracing the route to 1.0.0.1<br/><br/>  1 192.168.201.1 [MPLS: Label 22 Exp 0] 56 msec 60 msec 56 msec<br/>  2 192.168.201.6 56 msec 56 msec 56 msec<br/>  3 192.168.0.6 56 msec *  56 msec</pre>The MPLS ping and traceroute commands, introduced in IOS release 12.0(27)S and integrated in mainstream IOS release 12.4(6)T (at least five years too late in my humble opinion) address this problem: they both use IP packets that are <a href="http://www.cisco.com/en/US/products/sw/iosswrel/ps1829/products_feature_guide09186a00801eb054.html#wp1086556">not capable of being IP-switched</a> and thus report the exact failure spot.&lt;!--more--&gt;In our scenario, MPLS ping and traceroute correctly identified the problem (unlabeled output interface) and the MPLS traceroute also provides the correct IP address of the offending router.<pre class="code">ro#<strong>ping mpls ip 1.0.0.1 255.255.255.255</strong><br/>Sending 5, 100-byte MPLS Echos to 1.0.0.1/32,<br/>     timeout is 2 seconds, send interval is 0 msec:<br/><br/>Codes: '!' - success, 'Q' - request not sent, '.' - timeout,<br/>  'L' - labeled output interface, 'B' - unlabeled output interface,<br/>  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,<br/>  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no label entry,<br/>  'P' - no rx intf label prot, 'p' - premature termination of LSP,<br/>  'R' - transit router, 'I' - unknown upstream index,<br/>  'X' - unknown return code, 'x' - return code 0<br/><br/>Type escape sequence to abort.<br/>BBBBB<br/>Success rate is 0 percent (0/5)<br/>ro#<strong>trace mpls ip 1.0.0.1 255.255.255.255</strong><br/>Tracing MPLS Label Switched Path to 1.0.0.1/32, timeout is 2 seconds<br/><br/>Codes: '!' - success, 'Q' - request not sent, '.' - timeout,<br/>  'L' - labeled output interface, 'B' - unlabeled output interface,<br/>  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,<br/>  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no label entry,<br/>  'P' - no rx intf label prot, 'p' - premature termination of LSP,<br/>  'R' - transit router, 'I' - unknown upstream index,<br/>  'X' - unknown return code, 'x' - return code 0<br/><br/>Type escape sequence to abort.<br/>  0 192.168.201.2 MRU 1500 [Labels: 22 Exp: 0]<br/>B 1 192.168.201.1 MRU 1504 [No Label] 64 ms</pre>After the problem has been fixed, both commands report successful tests:<pre class="code">ro#<strong>trace mpls ip 1.0.0.1 255.255.255.255</strong><br/>Tracing MPLS Label Switched Path to 1.0.0.1/32, timeout is 2 seconds<br/><br/>Codes: '!' - success, 'Q' - request not sent, '.' - timeout,<br/>  'L' - labeled output interface, 'B' - unlabeled output interface,<br/>  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,<br/>  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no label entry,<br/>  'P' - no rx intf label prot, 'p' - premature termination of LSP,<br/>  'R' - transit router, 'I' - unknown upstream index,<br/>  'X' - unknown return code, 'x' - return code 0<br/><br/>Type escape sequence to abort.<br/>  0 192.168.201.2 MRU 1500 [Labels: 22 Exp: 0]<br/>I 1 192.168.201.1 MRU 1500 [Labels: 16 Exp: 0] 68 ms<br/>I 2 192.168.201.6 MRU 1504 [Labels: implicit-null Exp: 0] 140 ms<br/>! 3 192.168.0.6 112 ms<br/>ro#<strong>ping mpls ip 1.0.0.1 255.255.255.255</strong><br/>Sending 5, 100-byte MPLS Echos to 1.0.0.1/32,<br/>     timeout is 2 seconds, send interval is 0 msec:<br/><br/>Codes: '!' - success, 'Q' - request not sent, '.' - timeout,<br/>  'L' - labeled output interface, 'B' - unlabeled output interface,<br/>  'D' - DS Map mismatch, 'F' - no FEC mapping, 'f' - FEC mismatch,<br/>  'M' - malformed request, 'm' - unsupported tlvs, 'N' - no label entry,<br/>  'P' - no rx intf label prot, 'p' - premature termination of LSP,<br/>  'R' - transit router, 'I' - unknown upstream index,<br/>  'X' - unknown return code, 'x' - return code 0<br/><br/>Type escape sequence to abort.<br/>!!!!!<br/>Success rate is 100 percent (5/5), round-trip min/avg/max = 100/103/104 ms</pre>

