---
title: "OSPF graceful shutdown"
date: "2007-08-14T07:15:00.000+02:00"
tags: [ OSPF ]
---

<p>Reloading a core router in a high-availability network is always a tricky proposition. Even if you tweak the routing protocol hello timers (or use fast L2 mechanisms to detect next-hop loss), it still takes a few seconds for the routing protocols to converge. For example, when using OSPF, the adjacent routers have to detect the neighbor loss, change their router LSAs, flood them (LSA flooding is rate-limited), the changed LSAs have to be propagated across the whole area and all routers in the area have to run SPF (which is also rate-limited). It's much better if you could gracefully take a router offline by increasing the OSPF cost on all its interfaces, thus forcing an OSPF SPF run while the router is still capable of forwarding the traffic (resulting in no packet loss).</p>
<p>The <a href="http://www.cisco.com/univercd/cc/td/doc/product/software/ios122/122newft/122t/122t4/ftospfau.htm">OSPF stub router advertisement</a> (as this feature is officially called) documented in <a href="http://www.faqs.org/rfcs/rfc3137.html">RFC 3137</a> is implemented in Cisco IOS release 12.2(4)T and 12.3. To force the router into stub status (prior to reboot/shutdown), use the <strong>max-metric router-lsa</strong> router configuration command. This command will change the OSPF metric for all non-stub interfaces in the router LSA to 65535.</p>
<p class="note"><span>Note: </span>The <em>infinite</em> metric in the router LSA does not force the other routers to ignore the path, just nudge them into using alternate paths. The other routers in the network will thus select alternate OSPF paths (if they exist), but not the potential non-OSPF paths. Those will be selected only after the actual router reboot/shutdown.</p>
&lt;!--more--&gt;<p>This is a sample router LSA after the max-metric router-lsa has been configured:</p>
<pre class="code">b1#<strong>show ip ospf data router 172.16.0.21</strong><br/><br/>OSPF Router with ID (172.16.0.21) (Process ID 1)<br/><br/>Router Link States (Area 0)<br/><br/>Exception Flag: Announcing maximum link costs<br/>LS age: 18<br/>Options: (No TOS-capability, DC)<br/>LS Type: Router Links<br/>Link State ID: 172.16.0.21<br/>Advertising Router: 172.16.0.21<br/>LS Seq Number: 80000003<br/>Checksum: 0x88B2<br/>Length: 72<br/>Number of Links: 4<br/><br/>Link connected to: a Stub Network<br/>(Link ID) Network/subnet number: 172.16.0.21<br/>(Link Data) Network Mask: 255.255.255.255<br/>Number of TOS metrics: 0<br/>TOS 0 Metrics: 1<br/><br/>Link connected to: another Router (point-to-point)<br/>(Link ID) Neighboring Router ID: 172.16.0.11<br/>(Link Data) Router Interface address: 172.16.1.2<br/>Number of TOS metrics: 0<br/><span class="high"> TOS 0 Metrics: 65535</span><br/><br/>Link connected to: a Stub Network<br/>(Link ID) Network/subnet number: 172.16.1.0<br/>(Link Data) Network Mask: 255.255.255.252<br/>Number of TOS metrics: 0<br/>TOS 0 Metrics: 50<br/><br/>Link connected to: a Transit Network<br/>(Link ID) Designated Router address: 192.168.0.6<br/>(Link Data) Router Interface address: 192.168.0.5<br/>Number of TOS metrics: 0<br/><span class="high"> TOS 0 Metrics: 65535</span></pre>

