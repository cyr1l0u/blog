---
title: "Using EVPN in Very Small Data Center Fabrics"
date: "2018-02-06T09:01:00.000+01:00"
tags: [ Design,Data Center,Fabric,EVPN ]
---

<p>I had an interesting &ldquo;<em>how do you build a small fabric without throwing every technology in the mix</em>&rdquo; discussion with <a href="http://www.ipspace.net/Expert:Nicola_Modena">Nicola Modena</a> and mentioned that I don&rsquo;t see a reason to use EVPN in fabrics with just a few switches. He disagreed and gave me a few good scenarios where EVPN might be handy. Before discussing them let&rsquo;s establish a baseline.</p>
<h4>The Setup</h4><p>Assume you&rsquo;re building two small data center fabrics (small because you have only a few hundred VMs and two because redundancy and IT auditors).<!--more--></p>
<p>You don&rsquo;t need more than two switches in each data center, and because the bandwidth requirements are usually reasonably small, and long-distance links are expensive, you could connect them like this:</p>
<div class='separator'><a href="https://3.bp.blogspot.com/-mv-lA7T_7bM/Wna9YFJuI1I/AAAAAAAAJDw/cWwH1snwS7cLqKDBnyg5Hz24cPsVO6dewCLcBGAs/s1600/SmallFabric.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-mv-lA7T_7bM/Wna9YFJuI1I/AAAAAAAAJDw/cWwH1snwS7cLqKDBnyg5Hz24cPsVO6dewCLcBGAs/s550/SmallFabric.png" data-original-width="1280" data-original-height="942" /></a></div>
<p>Furthermore (because we&rsquo;re dealing with an Enterprise design) assume you have to support end-to-end layer-2 connectivity across this fabric.</p>
<p class="warn">As you know I would never ever recommend a customer to do that, but sometimes in a <a href="http://www.ipspace.net/Consulting">consulting engagement</a> you have more important battles to fight in a limited amount of time.</p>
<p>To keep things simple, we&rsquo;ll assume everyone involved wants to have the simplest possible fabric design and so we won&rsquo;t be using port channels between servers and switches but rely on active/standby links or whatever other load distribution mechanism the servers (or hypervisors) provide.</p>
<div class='separator'><a href="https://3.bp.blogspot.com/-BpCMGIyK5FY/Wna9XTl-MoI/AAAAAAAAJDs/tsABfw_Du-Y06RQvCbydeb1dMASdrmS0QCLcBGAs/s1600/SmallFabric-Servers.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-BpCMGIyK5FY/Wna9XTl-MoI/AAAAAAAAJDs/tsABfw_Du-Y06RQvCbydeb1dMASdrmS0QCLcBGAs/s550/SmallFabric-Servers.png" data-original-width="1248" data-original-height="1136" /></a></div>
<h4>Let&rsquo;s do it the old way first</h4><p>In my simplistic design, I&rsquo;d use VXLAN encapsulation with ingress replication based on static flood lists:</p>
<ul class="ListParagraph"><li>I&rsquo;d use pure IP routing within the fabric;</li>
<li>Switches would use VXLAN encapsulation to transport Ethernet traffic across IP fabric;</li>
<li>Ingress replication would be used instead of IP multicast to implement VXLAN flooding of BUM frames;</li>
<li>Dynamic MAC learning relying on BUM flooding would be used to populate MAC-to-VTEP tables;</li>
<li>Instead of using a control-plane protocol to build the list of remote VTEPs to which the traffic needs to be flooded I&rsquo;d use a static list of remote VTEPs configured on every switch.</li>
</ul>
<div class='separator'><a href="https://1.bp.blogspot.com/-VFVA0g99fhI/Wna9XQhAMdI/AAAAAAAAJDo/ulyLkCvIqiIgEi8kA_xUqxA-r7Yg9iWHwCLcBGAs/s1600/SmallFabric-IngressVXLAN.png" imageanchor="1" ><img border="0" src="https://1.bp.blogspot.com/-VFVA0g99fhI/Wna9XQhAMdI/AAAAAAAAJDo/ulyLkCvIqiIgEi8kA_xUqxA-r7Yg9iWHwCLcBGAs/s550/SmallFabric-IngressVXLAN.png" data-original-width="1220" data-original-height="1138" /></a></div>
<p>Admittedly, you&rsquo;d have to do some configuration tweaking every time you&rsquo;d add a switch to my fabric design, but it would be very easy to write a simple Ansible playbook to generate the switch configuration. If you want to learn how to do that check the <a href="http://www.ipspace.net/Ansible_for_Networking_Engineers">Ansible for Networking Engineers</a> online course.</p>
<h4>Now add EVPN to the mix</h4><p>Instead of configuring VTEP flood lists manually you could use EVPN control plane between the four switches. I would use a full mesh of IBGP sessions to keep the design as simple as possible (remembering I&rsquo;d have to go for route reflectors if the fabric grows).</p>
<div class='separator'><a href="https://2.bp.blogspot.com/-ZEpn0Obx3EA/Wna9XZLkZaI/AAAAAAAAJDk/S_GzOS12KgkDQ2nXMWmzkFSrIu2MzcoTgCLcBGAs/s1600/SmallFabric-EVPN-Basic.png" imageanchor="1" ><img border="0" src="https://2.bp.blogspot.com/-ZEpn0Obx3EA/Wna9XZLkZaI/AAAAAAAAJDk/S_GzOS12KgkDQ2nXMWmzkFSrIu2MzcoTgCLcBGAs/s550/SmallFabric-EVPN-Basic.png" data-original-width="1275" data-original-height="1148" /></a></div>
<p>EVPN would automatically build the flood lists, removing the need for manual configuration, and propagate customer MAC addresses using BGP.</p>
<p>So far, there&rsquo;s very little advantage of using EVPN, and a disadvantage of using a pretty complex piece of technology; things get a bit more interesting when you want to implement MLAG or layer-3 forwarding.</p>
<p class="info">EVPN does reduce configuration complexity in environments that can't spell <em>automation</em>. You have to configure static flood lists per VNI, whereas you only have to configure EVPN IBGP neighbors once.</p>
<h4>Want to know more?</h4><p>If you&rsquo;re building a small fabric with just a few switches you might get a good design <a href="http://www.ipspace.net/Optimize_Data_Center_Infrastructure">following recipes you find on the Internet</a>&hellip; but when you start building larger fabrics your designs will be better if you understand the underlying technology and its tradeoffs. You&rsquo;ll discover those in the <a href="http://www.ipspace.net/Roadmap/Data_center_webinars">Data Center webinars</a> and <a href="http://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics">Designing and Building Data Center Fabrics self-paced online course</a>.</p>
<p>Some of you will have to design more than just the transport fabric. You&rsquo;ll find all the material from the data center fabrics course, and more details on compute, virtualization, storage, and network services in the <a href="http://www.ipspace.net/Building_Next-Generation_Data_Center">Building Next-Generation Data Center</a> instructor-led online course.</p>
<p>Finally, to learn more about the EVPN technology, check out the <a href="http://www.ipspace.net/EVPN">EVPN Technical Deep Dive</a> webinar. </p>

