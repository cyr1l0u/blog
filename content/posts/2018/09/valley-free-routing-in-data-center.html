---
title: "Valley-Free Routing in Data Center Fabrics"
date: "2018-09-17T07:48:00.000+02:00"
tags: [ Design,Data Center,BGP ]
---

<p>You might have noticed that almost every <em><a href="https://www.ipspace.net/Data_Center_BGP">BGP as Data Center IGP</a></em> design uses <a href="https://www.ipspace.net/Data_Center_BGP/Autonomous_Systems_and_AS_Numbers">the same AS number on all spine switches</a> (there are exceptions coming from people who use BGP as RIP with AS-path length serving as hop count&hellip; but let&rsquo;s not go there).</p>
<p>There are two reasons for that design choice:<!--more--></p>
<ul class="ListParagraph"><li>Default BGP AS-path filters immediately stop path hunting after a link failure;</li>
<li>The same default filters give you <a href="https://blog.ipspace.net/2018/09/valley-free-routing.html">valley-free</a> (or <a href="https://blog.ipspace.net/2018/09/repost-tony-przygienda-on-valley-free.html">non-zigzag</a>) routing &ndash; traffic between two leaf switches never traverses another leaf switch, making traffic flows and link utilization way more predictable.</li>
</ul>
<p>We covered the drawbacks of path hunting in the <a href="https://my.ipspace.net/bin/list?id=Clos#L3_SINGLE">Layer-3 fabrics section</a> of <a href="https://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabrics</a> webinar&hellip; but what about the benefits or drawbacks of valley-free traffic flow?</p>
<p>Imagine a simple leaf-and-spine fabric that experienced a link failure.</p>
<div class='separator'><a href="https://3.bp.blogspot.com/-T1rrZUV-yAE/W5lD7Unlf9I/AAAAAAAAJNs/2k1_Jf29o44DQNq4yvymYaAHhnmMwuWZQCLcBGAs/s1600/VF_DC_LinkFailure.png" imageanchor="1" ><img border="0" src="https://3.bp.blogspot.com/-T1rrZUV-yAE/W5lD7Unlf9I/AAAAAAAAJNs/2k1_Jf29o44DQNq4yvymYaAHhnmMwuWZQCLcBGAs/s400/VF_DC_LinkFailure.png" width="400" height="136" data-original-width="1600" data-original-height="545" /></a></div>
<p>If the fabric routing protocol design isn&rsquo;t valley-free, C1 finds numerous alternate paths to L1: (L2 =&gt; C2, L3 =&gt; C2, L4 =&gt; C2), resulting in an explosion of forwarding table on C1, and plenty of routing protocol noise&hellip; but there&rsquo;s no change in end-to-end forwarding &ndash; the path through the valley is longer than the direct path through C2. So far so good.</p>
<p>What about two link failures:</p>
<div class='separator'><a href="https://1.bp.blogspot.com/-V6pTrspRXbM/W5lEJl-RJqI/AAAAAAAAJNw/Mo0LRWOAjBoNhmsGreWHIMKUwpCn5YtrwCLcBGAs/s1600/VF_DC_LinkFailure_2.png" imageanchor="1" ><img border="0" src="https://1.bp.blogspot.com/-V6pTrspRXbM/W5lEJl-RJqI/AAAAAAAAJNw/Mo0LRWOAjBoNhmsGreWHIMKUwpCn5YtrwCLcBGAs/s400/VF_DC_LinkFailure_2.png" width="400" height="137" data-original-width="1600" data-original-height="549" /></a></div>
<p>In this case, a path through a valley is the only way to get from L1 to L4, so it seems like valley-free routing is not a good idea.</p>
<p>As always, there&rsquo;s a tradeoff, and if you haven&rsquo;t identified it, you haven&rsquo;t looked hard enough. If you have a fabric with two spines, valley-free routing breaks connectivity after two failures&hellip; but then you might be <a href="https://blog.ipspace.net/2018/05/is-ospf-or-is-is-good-enough-for-my.html">better off using OSPF anyway</a>. As an alternative, you could <a href="https://blog.ipspace.net/2018/06/avoid-summarization-in-leaf-and-spine.html">use a spine-to-spine link</a> to increase failure resilience, but that increases routing complexity.</p>
<p class="note">It&rsquo;s really hard to implement valley-free routing with OSPF anyway. More about that in another blog post.</p>
<p>In larger fabrics you&rsquo;d probably want to use four spine switches, and you need four strategically-placed failures to break connectivity with valley-free routing, so it&rsquo;s much better to focus on routing protocol convergence than on fabric partitioning.</p>
<p><b>Takeaway <a href="https://blog.ipspace.net/2011/08/road-to-complex-designs-is-paved-with.html">recipe</a>:</b> If you have two spine switches, use OSPF or IS-IS (instead of turning BGP into RIP). If you have more than two spine switches and you think you need BGP as the underlay routing protocol, use the same AS number on all spines to get valley-free routing.</p>
<p class="info">ipSpace.net subscribers can find way more details in <a href="https://www.ipspace.net/Leaf-and-Spine_Fabric_Architectures">Leaf-and-Spine Fabrics webinar</a>; if you want to add interactive discussions and mentoring to your learning process, go for the <a href="https://www.ipspace.net/Designing_and_Building_Data_Center_Fabrics">Designing and Building Data Center Fabrics</a> or <a href="https://www.ipspace.net/Building_Next-Generation_Data_Center">Building Next-Generation Data Centers</a> online course.</p>

