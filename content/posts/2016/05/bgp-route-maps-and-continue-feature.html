---
title: "BGP Route Maps and Continue Feature Limitations"
date: "2016-05-09T09:14:00.000+02:00"
tags: [ BGP ]
---

<p>One of my <a href="http://www.ipspace.net/ExpertExpress">ExpertExpress</a> engagements focused on BGP route maps and setting BGP attributes based on BGP communities, so I wanted to brush up my RouteMapFoo before the online session.</p>
<p>Here are a few (not-so-unexpected) results gathered from IOSv release 15.5(3)M.<!--more--></p>
<p><strong>TL&amp;DR</strong>: The <strong>continue </strong>feature works only in route maps applied to BGP neighbors.</p>
<h4>Test setup</h4><p>I built a four node network in VIRL representing an ISP network with an upstream provider, access network running OSPF with the core network, and a BGP client:</p>
<div class='separator'><a href="https://4.bp.blogspot.com/-CrQHvQzikUM/Vy7l_3FJTQI/AAAAAAAAIeA/jGnaPFaPiY0Xwh8bgeHgx_zRrdKUnw_8ACLcB/s1600/Screenshot%2B2016-05-01%2B12.10.32.png" imageanchor="1" ><img border="0" src="https://4.bp.blogspot.com/-CrQHvQzikUM/Vy7l_3FJTQI/AAAAAAAAIeA/jGnaPFaPiY0Xwh8bgeHgx_zRrdKUnw_8ACLcB/s400/Screenshot%2B2016-05-01%2B12.10.32.png" /></a></div>
<p class="more">The <a href="https://github.com/ipspace/VIRL/blob/master/BGP%20Route%20Maps.virl">VIRL file describing the topology</a> (including working router configurations) is in my <a href="https://github.com/ipspace/VIRL">VIRL GitHub repository</a>.</p>
<p>The <em>access</em> router is redistributing static routes pointing toward customers into OSPF and copying static route tags into OSPF tags:</p>
<pre class="code">router&nbsp;ospf&nbsp;64501<br />&nbsp;redistribute&nbsp;static&nbsp;subnets<br />&nbsp;passive-interface&nbsp;Loopback0<br />!<br />ip&nbsp;route&nbsp;192.168.1.0&nbsp;255.255.255.0&nbsp;Null0&nbsp;tag&nbsp;2000<br />ip&nbsp;route&nbsp;192.168.2.1&nbsp;255.255.255.255&nbsp;Null0&nbsp;tag&nbsp;2001</pre><p>Nice surprise: automatic copy of route tags from static routes to OSPF external routes works:</p>
<pre class="code">Access#<strong>show&nbsp;ip&nbsp;ospf&nbsp;database&nbsp;external</strong><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OSPF&nbsp;Router&nbsp;with&nbsp;ID&nbsp;(192.168.0.6)&nbsp;(Process&nbsp;ID&nbsp;64501)<br /><br />Type-5&nbsp;AS&nbsp;External&nbsp;Link&nbsp;States<br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;742<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.1.0&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.6<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0x21CD<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/24<br />Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />MTID:&nbsp;0<br />Metric:&nbsp;20<br />Forward&nbsp;Address:&nbsp;0.0.0.0<br /><strong></strong><span class=" high"><strong>External&nbsp;Route&nbsp;Tag:&nbsp;2000</strong></span><br /><br />&nbsp;&nbsp;LS&nbsp;age:&nbsp;660<br />&nbsp;&nbsp;Options:&nbsp;(No&nbsp;TOS-capability,&nbsp;DC,&nbsp;Upward)<br />&nbsp;&nbsp;LS&nbsp;Type:&nbsp;AS&nbsp;External&nbsp;Link<br />&nbsp;&nbsp;Link&nbsp;State&nbsp;ID:&nbsp;192.168.2.1&nbsp;(External&nbsp;Network&nbsp;Number&nbsp;)<br />&nbsp;&nbsp;Advertising&nbsp;Router:&nbsp;192.168.0.6<br />&nbsp;&nbsp;LS&nbsp;Seq&nbsp;Number:&nbsp;80000001<br />&nbsp;&nbsp;Checksum:&nbsp;0xCE0<br />&nbsp;&nbsp;Length:&nbsp;36<br />&nbsp;&nbsp;Network&nbsp;Mask:&nbsp;/32<br />Metric&nbsp;Type:&nbsp;2&nbsp;(Larger&nbsp;than&nbsp;any&nbsp;link&nbsp;state&nbsp;path)<br />MTID:&nbsp;0<br />Metric:&nbsp;20<br />Forward&nbsp;Address:&nbsp;0.0.0.0<br /><span class=" high"><strong>External&nbsp;Route&nbsp;Tag:&nbsp;2001</strong></span></pre><h4>Redistribution route maps</h4><p>Next test: redistribute OSPF routes into BGP with a route map to set BGP attributes in the redistribution point. </p>
<p>In the redistribution route-map I wanted to:</p>
<ul class="ListParagraph"><li>Set origin to IGP and add BGP community 64501:1 for internal OSPF routes;</li>
<li>Set origin to EGP 64501 and add BGP community 64501:2 for external OSPF routes;</li>
<li>Add BGP community 64501:2000 for external OSPF routes with tag 2000. </li>
</ul>
<p class="note">Before you ask: I had no really good reason to do that, but my customer was using something along the same lines, so I wanted to test all potential combinations.</p>
<p>This would be the ideal route-map to do that:</p>
<pre class="code">route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;10<br />&nbsp;match&nbsp;route-type&nbsp;external<br />&nbsp;continue<br />&nbsp;set&nbsp;origin&nbsp;egp&nbsp;64501<br />&nbsp;set&nbsp;community&nbsp;64501:2&nbsp;additive<br />!<br />route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;11<br />&nbsp;match&nbsp;route-type&nbsp;internal<br />&nbsp;continue<br />&nbsp;set&nbsp;origin&nbsp;igp<br />&nbsp;set&nbsp;community&nbsp;64501:2001&nbsp;additive<br />!<br />route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;20<br />&nbsp;match&nbsp;tag&nbsp;2000<br />&nbsp;set&nbsp;community&nbsp;64501:2000&nbsp;additive<br /></pre><p><strong>Caveat#1</strong>: EGP keyword is hidden in recent IOS releases (I&#x2019;d consider that a good thing). It still works, but it won&#x2019;t show in context-sensitive help.</p>
<p>I also stumbled upon two limitations of route maps used to control redistribution of routing information between routing protocols:</p>
<p><strong>Caveat#</strong><strong>2</strong>: You cannot use <strong>set community additive </strong>in a redistribution route-map </p>
<p><strong>Caveat#</strong><strong>3</strong>: You cannot use <strong>continue </strong>clause in a redistribution route-map.</p>
<p class="info">The lack of support for <strong>continue </strong>clause was somewhat expected after reading the <a href="http://www.cisco.com/c/en/us/td/docs/ios-xml/ios/iproute_bgp/configuration/15-mt/irg-15-mt-book/irg-route-map-continue.html">relevant IOS documentation</a>, and without the <strong>continue </strong>clause it makes no sense using <strong>set community additive </strong>in a redistribution point (where source routes have no BGP communities).</p>
<p>In both cases Cisco IOS warns you when configuring redistribution with <strong>redistribute route-map</strong> command:</p>
<pre class="code">Core(config)#router&nbsp;bgp&nbsp;64501<br />Core(config-router)#addr&nbsp;ipv4<br />Core(config-router-af)#redist<br />Core(config-router-af)#redistribute&nbsp;ospf&nbsp;64501&nbsp;route-map&nbsp;OSPF2BGP<br />%&nbsp;"OSPF2BGP"&nbsp;used&nbsp;as&nbsp;redistribute&nbsp;ospf&nbsp;into&nbsp;bgp&nbsp;route-map,&nbsp;continue&nbsp;match&nbsp;not&nbsp;supported<br />%&nbsp;not&nbsp;supported&nbsp;match&nbsp;will&nbsp;behave&nbsp;as&nbsp;route-map&nbsp;with&nbsp;no&nbsp;match</pre><p>I had to rewrite the route map with entries matching each combination of the OSPF attributes (obviously starting with the most-specific scenarios first) and setting all desired BGP communities in one route-map entry:</p>
<pre class="code">route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;10<br />&nbsp;match&nbsp;tag&nbsp;2000<br />&nbsp;match&nbsp;route-type&nbsp;external<br />&nbsp;set&nbsp;origin&nbsp;egp&nbsp;64501<br />&nbsp;set&nbsp;community&nbsp;64501:2&nbsp;64501:2000<br />!<br />route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;20<br />&nbsp;match&nbsp;route-type&nbsp;external<br />&nbsp;set&nbsp;origin&nbsp;egp&nbsp;64501<br />&nbsp;set&nbsp;community&nbsp;64501:2<br />!<br />route-map&nbsp;OSPF2BGP&nbsp;permit&nbsp;30<br />&nbsp;match&nbsp;route-type&nbsp;internal<br />&nbsp;set&nbsp;origin&nbsp;igp<br />&nbsp;set&nbsp;community&nbsp;64501:1</pre><p>It&#x2019;s ugly but at least it works:</p>
<pre class="code">Core#<strong>show&nbsp;ip&nbsp;bgp&nbsp;192.168.1.0</strong><br />BGP&nbsp;routing&nbsp;table&nbsp;entry&nbsp;for&nbsp;192.168.1.0/24,&nbsp;version&nbsp;19<br />Paths:&nbsp;(1&nbsp;available,&nbsp;best&nbsp;#1,&nbsp;table&nbsp;default)<br />&nbsp;&nbsp;Advertised&nbsp;to&nbsp;update-groups:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />&nbsp;&nbsp;Refresh&nbsp;Epoch&nbsp;1<br />&nbsp;&nbsp;Local<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.128.2&nbsp;from&nbsp;0.0.0.0&nbsp;(192.168.0.5)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=" high">Origin&nbsp;EGP</span>,&nbsp;metric&nbsp;20,&nbsp;localpref&nbsp;100,&nbsp;weight&nbsp;32768,&nbsp;valid,&nbsp;sourced,&nbsp;best<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=" high">Community:&nbsp;64501:2&nbsp;64501:2000</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rx&nbsp;pathid:&nbsp;0,&nbsp;tx&nbsp;pathid:&nbsp;0x0<br />Core#show&nbsp;ip&nbsp;bgp&nbsp;192.168.2.1<br />BGP&nbsp;routing&nbsp;table&nbsp;entry&nbsp;for&nbsp;192.168.2.1/32,&nbsp;version&nbsp;20<br />Paths:&nbsp;(1&nbsp;available,&nbsp;best&nbsp;#1,&nbsp;table&nbsp;default)<br />&nbsp;&nbsp;Advertised&nbsp;to&nbsp;update-groups:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br />&nbsp;&nbsp;Refresh&nbsp;Epoch&nbsp;1<br />&nbsp;&nbsp;Local<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.128.2&nbsp;from&nbsp;0.0.0.0&nbsp;(192.168.0.5)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=" high">Origin&nbsp;EGP</span>,&nbsp;metric&nbsp;20,&nbsp;localpref&nbsp;100,&nbsp;weight&nbsp;32768,&nbsp;valid,&nbsp;sourced,&nbsp;best<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=" high">Community:&nbsp;64501:2</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rx&nbsp;pathid:&nbsp;0,&nbsp;tx&nbsp;pathid:&nbsp;0x0</pre><p class="warn">In the worst case, the limitations on redistribute route-maps result in a Cartesian product of all possible match conditions. Definitely not something I&#x2019;d want to configure manually. Is anyone aware of a tool that would generate route-maps with all possible combinations of <strong>match </strong>criteria automatically?</p>
<h4>Network origination route-maps</h4><p>I tried to use a slightly different approach on the <em>client </em>router: insert static routes into BGP using <strong>network </strong>statement with a <strong>route-map </strong>option.</p>
<pre class="code">router&nbsp;bgp&nbsp;65001<br />&nbsp;bgp&nbsp;router-id&nbsp;192.168.0.9<br />&nbsp;bgp&nbsp;log-neighbor-changes<br />&nbsp;neighbor&nbsp;10.0.0.1&nbsp;remote-as&nbsp;64501<br />&nbsp;neighbor&nbsp;10.0.0.1&nbsp;description&nbsp;eBGP&nbsp;to&nbsp;Core<br />&nbsp;!<br />&nbsp;address-family&nbsp;ipv4<br />&nbsp;&nbsp;network&nbsp;192.168.11.0&nbsp;route-map&nbsp;Static2BGP<br />&nbsp;&nbsp;network&nbsp;192.168.12.1&nbsp;mask&nbsp;255.255.255.255&nbsp;route-map&nbsp;Static2BGP</pre><p><strong>Caveat#1</strong>: The <strong>continue </strong>feature doesn&#x2019;t work when using a route map in a <strong>network </strong>statement.</p>
<p><strong>Caveat#2</strong>: Cisco IOS doesn&#x2019;t even complain.</p>
<p>However, there were also some good news:</p>
<ul class="ListParagraph"><li>Matching static route tags works;</li>
<li>You can use <strong>set community additive </strong>command (although it doesn&#x2019;t do you much good if you can&#x2019;t use <strong>continue </strong>command).</li>
</ul>
<h4>Inbound BGP Neighbor Route Maps</h4><p>Finally, I wanted to test whether the <strong>continue </strong>feature works in inbound route maps applied to individual BGP neighbors. Here&#x2019;s what I wanted to achieve:</p>
<ul class="ListParagraph"><li>Set MED of all incoming routes to 75;</li>
<li>Set local preference of routes with community 64501:2000 to 2000</li>
<li>Prepend remote AS to routes with community 64501:3</li>
</ul>
<p>Here&#x2019;s the route map I used:</p>
<pre class="code">ip&nbsp;community-list&nbsp;standard&nbsp;ClientPrepend&nbsp;permit&nbsp;64501:3<br />ip&nbsp;community-list&nbsp;standard&nbsp;ClientLocPref&nbsp;permit&nbsp;64501:2000<br />!<br />route-map&nbsp;FromClient&nbsp;permit&nbsp;10<br />&nbsp;continue<br />&nbsp;set&nbsp;metric&nbsp;75<br />!<br />route-map&nbsp;FromClient&nbsp;permit&nbsp;20<br />&nbsp;match&nbsp;community&nbsp;ClientPrepend<br />&nbsp;continue<br />&nbsp;set&nbsp;as-path&nbsp;prepend&nbsp;last-as&nbsp;3<br />!<br />route-map&nbsp;FromClient&nbsp;permit&nbsp;30<br />&nbsp;match&nbsp;community&nbsp;ClientLocPref<br />&nbsp;set&nbsp;local-preference&nbsp;10</pre><p>It worked without a glitch ;)</p>
<h4>Summary</h4><p>Here&#x2019;s the summary of how some route map features work in Cisco IOSv release 15.5(3)M (I didn&#x2019;t test route maps applied to outbound BGP route updates &ndash; that worked from day one):</p>
<table cellspacing="0" cellpadding="0" class="fmtTable">  <thead>  <tr class="TRFirst ">    <th valign="top" class="TDHead "></th>    <th valign="top" class="TDHead ">Matching tags</th>    <th valign="top" class="TDHead ">Adding communities</th>    <th valign="top" class="TDHead ">Route-map continue</th>  </tr>  </thead><tr><td valign="top"><p>Route redistribution</p>
</td><td valign="top"><p style="text-align: center;">Yes</p>
</td><td valign="top"><p style="text-align: center;">No</p>
</td><td valign="top"><p style="text-align: center;">No</p>
</td></tr><tr><td valign="top"><p>BGP origination with <strong>network </strong>statement</p>
</td><td valign="top"><p style="text-align: center;">Yes</p>
</td><td valign="top"><p style="text-align: center;">Yes</p>
</td><td valign="top"><p style="text-align: center;">No</p>
</td></tr><tr><td valign="top"><p>Processing inbound BGP updates</p>
</td><td valign="top"><p style="text-align: center;">N/A</p>
</td><td valign="top"><p style="text-align: center;">Yes</p>
</td><td valign="top"><p style="text-align: center;">Yes</p>
</td></tr><tr class="TRLast"><td valign="top" class="TDLast"><p>Processing outbound BGP updates</p>
</td><td valign="top" class="TDLast"><p style="text-align: center;">N/A</p>
</td><td valign="top" class="TDLast"><p style="text-align: center;">Yes</p>
</td><td valign="top" class="TDLast"><p style="text-align: center;">Yes</p>
</td></tr></table>

