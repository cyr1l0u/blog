---
title: "Directed ARP and ICMP Redirects"
date: "2016-06-15T11:46:00.000+02:00"
tags: [ ARP,IP routing ]
---

<p>One of my readers sent me this question:</p>
<blockquote class="cite">When I did my ***redacted*** I encountered a question about&nbsp;<strong>Directed ARP</strong>. The RFC (<a href="https://tools.ietf.org/html/rfc1433">https://tools.ietf.org/html/rfc1433</a>) is in the "experimental" stage, and I found it really weird from ***** to include such a hidden gem in the ***redacted***.</blockquote>
<p>Directed ARP is clearly one of those weird things that people were trying out in the early days of networking when packet forwarding and bandwidth were still expensive (read the RFC for more details), but I kept wondering &ldquo;<em>what exactly is going on when a host receives an ICMP redirect?</em>&rdquo; Time for a hands-on test.<!--more--></p>
<h4>Setup</h4><p>I built a very simple VIRL topology with a router and two servers connected to the same segment (you&#x2019;ll find the VIRL topology file and setup instructions in my <a href="https://github.com/ipspace/VIRL">VIRL Github repository</a>).</p>
<p>The relevant part of the router configuration is here:</p>
<pre class="code">interface&nbsp;GigabitEthernet0/1<br />&nbsp;description&nbsp;to&nbsp;L2<br />&nbsp;ip&nbsp;address&nbsp;10.0.1.1&nbsp;255.255.255.0&nbsp;secondary<br />&nbsp;ip&nbsp;address&nbsp;10.0.0.1&nbsp;255.255.255.0</pre><h4>Getting the redirects</h4><p>In theory, the router should send an ICMP redirect whenever two servers that try to communicate could communicate directly. In practice it doesn&#x2019;t. It looks like Cisco IOS behavior changed recently (make that &ldquo;in the last 10 years or so&rdquo;) as I remember seeing ICMP redirects using a similar setup sometime in previous millennium.</p>
<p>Time for a dirty trick: define a /16 subnet with two IP addresses on the router and keep the /24 subnets on the hosts. The router will think both hosts are in the same subnet and the two hosts will think they have to communicate across the router.</p>
<pre class="code">interface&nbsp;GigabitEthernet0/1<br />&nbsp;description&nbsp;to&nbsp;L2<br />&nbsp;ip&nbsp;address&nbsp;10.0.1.1&nbsp;255.255.0.0&nbsp;secondary<br />&nbsp;ip&nbsp;address&nbsp;10.0.0.1&nbsp;255.255.0.0</pre><p>Bingo! <strong>debug ip icmp </strong>displays ICMP redirects being sent to the hosts:</p>
<pre class="code">ICMP:&nbsp;redirect&nbsp;sent&nbsp;to&nbsp;10.0.0.5&nbsp;for&nbsp;dest&nbsp;10.0.1.5,&nbsp;use&nbsp;gw&nbsp;10.0.1.5<br />ICMP:&nbsp;redirect&nbsp;sent&nbsp;to&nbsp;10.0.1.5&nbsp;for&nbsp;dest&nbsp;10.0.0.5,&nbsp;use&nbsp;gw&nbsp;10.0.0.5</pre><p><strong>Lesson learned</strong>: Cisco IOS will send ICMP redirects <em>only when the source and destination IP addresses are in the same subnet</em>.</p>
<p>You might expect to see the redirect entries on the Linux servers. Guess what &ndash; you won&#x2019;t:</p>
<pre class="code">cisco@S1:~$&nbsp;<strong>ip&nbsp;route</strong><br />default&nbsp;via&nbsp;10.255.0.1&nbsp;dev&nbsp;eth0<br />10.0.0.0/24&nbsp;dev&nbsp;eth1&nbsp;&nbsp;proto&nbsp;kernel&nbsp;&nbsp;scope&nbsp;link&nbsp;&nbsp;src&nbsp;10.0.0.5<br />10.0.0.0/8&nbsp;via&nbsp;10.0.0.1&nbsp;dev&nbsp;eth1<br />10.255.0.0/16&nbsp;dev&nbsp;eth0&nbsp;&nbsp;proto&nbsp;kernel&nbsp;&nbsp;scope&nbsp;link&nbsp;&nbsp;src&nbsp;10.255.0.64</pre><p>You have to know that there should be a redirect entry in the cache, and once you know that, you can display it:</p>
<pre class="code">cisco@S1:~$&nbsp;<strong>ip&nbsp;route&nbsp;get&nbsp;10.0.1.5</strong><br />10.0.1.5&nbsp;via&nbsp;10.0.1.5&nbsp;dev&nbsp;eth1&nbsp;&nbsp;src&nbsp;10.0.0.5<br />&nbsp;&nbsp;&nbsp;&nbsp;cache&nbsp;&lt;redirected&gt;</pre><p>Makes troubleshooting extra simple, right? Just FYI: here&#x2019;s <a href="http://commandline.ninja/2015/06/18/damn-you-icmp-redirect-or-rather-how-to-flush-a-cached-icmp-redirect-under-centos7linux/">another epic struggle with the redirect cache</a>.</p>
<p class='update'>2016-06-17: Mathieu Millet suggested using <strong>ip route show cache</strong> command to display the whole redirect cache. Unfortunately that command doesn't work on the Ubuntu 14.04.2 LTS included with VIRL.</p>
<h4>ARPing around</h4><p>OK, we got the ICMP redirect into the Linux IPv4 route cache. Now let&#x2019;s see what happens when the two servers try to communicate directly.</p>
<p>Step#1: Start <strong>tcpdump </strong>on S2 to capture the ARP entries</p>
<pre class="code">cisco@S2:~$&nbsp;<strong>sudo&nbsp;tcpdump&nbsp;-n&nbsp;-i&nbsp;eth1&nbsp;arp&nbsp;&amp;</strong></pre><p class="note">VIRL uses <em>eth0 </em>on Linux servers to communicate with the outside world, and <strong>tcpdump </strong>uses the lowest-numbered interface by default, so I had to specify the interface name.</p>
<p>Step#2: Clear the ARP cache</p>
<pre class="code">cisco@S2:~$&nbsp;<strong>sudo&nbsp;ip&nbsp;neighbor&nbsp;flush&nbsp;all</strong></pre><p>Step#3: Ping S2 from S1 and inspect the <strong>tcpdump </strong>printout on S2</p>
<pre class="code">09:41:27.200279&nbsp;ARP,&nbsp;Request&nbsp;who-has&nbsp;10.0.1.5&nbsp;tell&nbsp;10.0.0.5,&nbsp;length&nbsp;28<br />09:41:27.200314&nbsp;ARP,&nbsp;Reply&nbsp;10.0.1.5&nbsp;is-at&nbsp;fa:16:3e:9f:d0:87,&nbsp;length&nbsp;28<br />09:41:27.200552&nbsp;ARP,&nbsp;Request&nbsp;who-has&nbsp;10.0.1.1&nbsp;tell&nbsp;10.0.1.5,&nbsp;length&nbsp;28<br />09:41:27.203598&nbsp;ARP,&nbsp;Reply&nbsp;10.0.1.1&nbsp;is-at&nbsp;fa:16:3e:63:f3:48,&nbsp;length&nbsp;46</pre><p><strong>Lesson learned</strong>: Linux kernel has no problems ARPing any IP address (even if it&#x2019;s outside of the interface subnet) as long as the IP routing table or IP cache claims the IP address is directly reachable.</p>
<h4>And now for some extra weirdness</h4><p>S1 created the redirect entry in its route cache while pinging S2, but S2 didn&#x2019;t even though the router was continuously sending ICMP redirects to S2.</p>
<pre class="code">root@S2:~#&nbsp;<strong>ping&nbsp;10.0.0.5</strong><br />PING&nbsp;10.0.0.5&nbsp;(10.0.0.5)&nbsp;56(84)&nbsp;bytes&nbsp;of&nbsp;data.<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=1&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)<br />64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=1&nbsp;ttl=64&nbsp;time=2.90&nbsp;ms<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=2&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)<br />64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=2&nbsp;ttl=64&nbsp;time=5.13&nbsp;ms<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=3&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)<br />64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=3&nbsp;ttl=64&nbsp;time=10.5&nbsp;ms<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=4&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)<br />64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=4&nbsp;ttl=64&nbsp;time=7.48&nbsp;ms<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=5&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)<br />64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=5&nbsp;ttl=64&nbsp;time=11.2&nbsp;ms<br />From&nbsp;10.0.0.1:&nbsp;icmp_seq=6&nbsp;Redirect&nbsp;Host(New&nbsp;nexthop:&nbsp;10.0.0.1)</pre><p class='update'>2016-06-17: Jim Hand sent me a nice email explaining the above problem - the ICMP redirect is coming from wrong source IP address. More in another blog post.</p>
<p>It&#x2019;s also interesting that <strong>ping </strong>claimed the next hop in the ICMP redirect is 10.0.0.1 &ndash; I even ran <strong>tcmpdump </strong>to verify Cisco IOS sent the correct next hop in ICMP redirect:</p>
<pre class="code">IP&nbsp;(tos&nbsp;0x0,&nbsp;ttl&nbsp;64,&nbsp;id&nbsp;24602,&nbsp;offset&nbsp;0,&nbsp;flags&nbsp;[DF],&nbsp;proto&nbsp;ICMP&nbsp;(1),&nbsp;length&nbsp;84)<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.1.5&nbsp;&gt;&nbsp;10.0.0.5:&nbsp;ICMP&nbsp;echo&nbsp;request,&nbsp;id&nbsp;1520,&nbsp;seq&nbsp;1,&nbsp;length&nbsp;64<br />IP&nbsp;(tos&nbsp;0x0,&nbsp;ttl&nbsp;255,&nbsp;id&nbsp;200,&nbsp;offset&nbsp;0,&nbsp;flags&nbsp;[none],&nbsp;proto&nbsp;ICMP&nbsp;(1),&nbsp;length&nbsp;56)<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.0.1&nbsp;&gt;&nbsp;10.0.1.5:&nbsp;ICMP&nbsp;redirect&nbsp;10.0.0.5&nbsp;to&nbsp;host&nbsp;10.0.0.5,&nbsp;length&nbsp;36<br />IP&nbsp;(tos&nbsp;0x0,&nbsp;ttl&nbsp;63,&nbsp;id&nbsp;24602,&nbsp;offset&nbsp;0,&nbsp;flags&nbsp;[DF],&nbsp;proto&nbsp;ICMP&nbsp;(1),&nbsp;length&nbsp;84)<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.1.5&nbsp;&gt;&nbsp;10.0.0.5:&nbsp;ICMP&nbsp;echo&nbsp;request,&nbsp;id&nbsp;1520,&nbsp;seq&nbsp;1,&nbsp;length&nbsp;64<br />IP&nbsp;(tos&nbsp;0x0,&nbsp;ttl&nbsp;64,&nbsp;id&nbsp;25789,&nbsp;offset&nbsp;0,&nbsp;flags&nbsp;[none],&nbsp;proto&nbsp;ICMP&nbsp;(1),&nbsp;length&nbsp;84)<br />&nbsp;&nbsp;&nbsp;&nbsp;10.0.0.5&nbsp;&gt;&nbsp;10.0.1.5:&nbsp;ICMP&nbsp;echo&nbsp;reply,&nbsp;id&nbsp;1520,&nbsp;seq&nbsp;1,&nbsp;length&nbsp;64</pre><p class='update'>2016-06-17: This seems to be a bug in <strong>ping</strong> utility. See comment by Anonymous below.</p>
<h4>Takeaway ;)</h4><p>While you can <a href="http://www.brainyquote.com/quotes/quotes/y/yogiberra125285.html">observe a lot by just watching</a> (or googling), you&#x2019;ll definitely learn more by getting your hands dirty.</p>

