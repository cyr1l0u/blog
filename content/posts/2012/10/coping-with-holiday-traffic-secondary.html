---
title: "Coping with Holiday Traffic – Secondary DHCP Subnets"
date: "2012-10-29T09:19:00.002+01:00"
tags: [ DHCP ]
---

<p>Years ago our IT assigned a /28 to my home office. It seemed enough; after all, who would ever have more than ~10 IP hosts at home (or <a href="https://video.arnes.si/portal/asset.zul?id=K1ETXpmORoMQkDeokYR8ZtNu">more than four computers at a site</a>).</p>
<p>When the number of Linux hosts and iGadgets started to grow, I occasionally ran out of IPv4 addresses, but managed to kludge my way around the problem by reducing DHCP lease time. However, when the start of school holidays coincided with the first snow storm of the season (so all the kids used their gadgets simultaneously) it was time to act.<!--more--></p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-1Ja_YBGfQLc/UI49LNgCS1I/AAAAAAAAFR4/6QZ70LAbNWQ/s1600/Slika0133.jpg" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="300" width="400" src="http://3.bp.blogspot.com/-1Ja_YBGfQLc/UI49LNgCS1I/AAAAAAAAFR4/6QZ70LAbNWQ/s400/Slika0133.jpg" /></a><br />We got ~20 cm (8 inches) of snow in the last two days</div>
<p class="info">Before you tell me IPv6 would be a solution – I know that, but none of my ISPs managed to configure IPv6 on my uplinks yet, and tunnels are so last millennium.</p>
<h4>Reducing lease time</h4><p>Some battery-powered gadgets turn off after a while ... but the IPv4 address they acquired is still leased to them, preventing some other gadget from getting Internet connectivity. Reducing lease time to a very short interval (30 seconds, for example) solves that problem ... as long as the number of <em>concurrently active </em>gadgets doesn’t exceed the threshold.</p>
<p>This is the relevant DHCP configuration from my home router:</p>
<p class="codecaption">Short DHCP lease time</p>
<pre class="code">ip dhcp pool DHCP<br />   network 192.168.200.192 255.255.255.240<br />   default-router 192.168.200.193<br />   domain-name example.com<br />   dns-server 192.168.200.193<br /><strong>   lease 0 0 30</strong></pre><h4>Adding a secondary subnet</h4><p>With the older kids bringing all sorts of fruity gadgets home, and having their smart phones connected to WiFi all the time, the reduced lease time trick collapsed ... and you probably know how nervous teenagers might get when they can’t connect to Facebook. It was time to add a secondary subnet.</p>
<p>Fortunately, Cisco introduced secondary DHCP subnets in 12.4T – I had to add only three lines to my router configuration to add the second subnet to my home network:</p>
<p class="codecaption">Secondary DHCP subnet</p>
<pre class="code">interface Vlan1<br /><strong> ip address 10.217.233.1 255.255.255.0 secondary</strong><br />!<br />ip dhcp pool DHCP<br />   network 192.168.200.192 255.255.255.240<br /><strong>   network 10.217.233.0 255.255.255.0 secondary</strong><br /><strong>     override default-router 10.217.233.1</strong><br />   default-router 192.168.200.193<br />   domain-name nil.si<br />   dns-server 192.168.200.193<br />   lease 0 0 30</pre><p>The secondary DHCP subnet functionality is exactly what I needed:</p>
<ul class="ListParagraph"><li>You don’t have to create a second DHCP pool with duplicate set of DHCP parameter;</li>
<li>You can still modify the default router value;</li>
<li><a href="http://www.cisco.com/en/US/docs/ios/12_4t/ip_addr/configuration/guide/htdhcpsv.html#wp1151571">Addresses are assigned from the secondary pool only if the primary pool is exhausted</a> (so all my devices will get addresses from the primary pool once the kids go back to school).</li>
</ul>
<p>Addressing problem solved ... now I have to find that second WiFi access point somewhere deep in my drawers.</p>

