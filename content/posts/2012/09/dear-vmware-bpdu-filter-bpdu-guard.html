---
title: "Dear VMware, BPDU Filter != BPDU Guard"
date: "2012-09-03T07:19:00.000+02:00"
tags: [ bridging,security,virtualization ]
---

<p>A while ago I <a href="http://blog.ioshints.info/2011/11/virtual-switches-need-bpdu-guard.html">described the need for BPDU guard in hypervisor switches</a>, and not surprisingly got a number of “it’s there” tweets seconds after vSphere 5.1 (which <a href="http://www.vmware.com/files/pdf/techpaper/Whats-New-VMware-vSphere-51-Network-Technical-Whitepaper.pdf">includes BPDU filter</a>) was launched. Rickard Nobel also did a <a href="http://rickardnobel.se/archives/1461">magnificent job of replicating the problem my blog post is describing and verifying vSphere 5.1 stops a BPDU denial-of-service attack</a>.</p>
<p>Unfortunately, BPDU filter is not the same feature as BPDU guard. Here’s why.<!--more--></p>
<p>Imagine a happily-running simple network with two switches, two hypervisors and two VMs belonging to the same VLAN:</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/--gkEUHJJY7Y/UECrlLp5-II/AAAAAAAAFGg/ZvbjtlTwXm8/s1600/Baseline.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="157" width="400" src="http://4.bp.blogspot.com/--gkEUHJJY7Y/UECrlLp5-II/AAAAAAAAFGg/ZvbjtlTwXm8/s400/Baseline.png" /></a></div>
<p>Now, for whatever weird reason the VM administrator decides to configure a VPN (or GRE) tunnel between the VMs and enables bridging between the Ethernet interface and the tunnel on both VMs.</p>
<p class="info">Actions like this are usually caused by <a href="http://en.wikipedia.org/wiki/Monte_Carlo_method">Monte Carlo</a> approach to device configuration: trying every combination of GUI-accessible features till one of them appears to be working. The <a href="http://en.wikipedia.org/wiki/Uncertainty_principle">Heisenbergian properties</a> of this approach can be greatly enhanced by throwing random results of Google search at the problem.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-_5tz5z6oHQI/UECrubcKiFI/AAAAAAAAFGs/RPDC9ZVbY5A/s1600/Bridging-over-VPN.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="176" width="400" src="http://2.bp.blogspot.com/-_5tz5z6oHQI/UECrubcKiFI/AAAAAAAAFGs/RPDC9ZVbY5A/s400/Bridging-over-VPN.png" /></a></div>
<p>Unless the VM administrator manages to mangle all the intelligence built into the VM protocol stack (and there are always ways of doing that – see <a href="http://msdn.microsoft.com/en-us/library/ee494722">DisableSTA in Windows registry</a>), the VMs configured as bridges start sending BPDUs through their physical interface, and any <a href="http://packetpushers.net/good-habits-for-basic-ethernet-switchport-provisioning-in-a-cisco-ios-environment/">properly configured switch</a> shuts down the offending port, preventing a forwarding loop ... and hosing the hypervisor host and all its VMs as a collateral damage.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-oBeF1CnNzTw/UECrz6ZYIxI/AAAAAAAAFG4/Gw2ICenoMvA/s1600/BPDU-Guard.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="176" width="400" src="http://2.bp.blogspot.com/-oBeF1CnNzTw/UECrz6ZYIxI/AAAAAAAAFG4/Gw2ICenoMvA/s400/BPDU-Guard.png" /></a></div>
<p>A malicious tenant could misuse BPDU guard for a BPDU-based denial-of-service attack (details in <a href="http://rickardnobel.se/archives/1461">Rickard Nobel’s blog post</a>), and VMware decided to prevent that by implementing BPDU filter (Net.BlockGuestBPDU variable) in its vSwitch. BPDU filter definitely prevents DoS attacks ... but it also destroys any chance of ever detecting a forwarding loop.</p>
<div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-m2_EHC3zKMc/UECr5KMtZ9I/AAAAAAAAFHE/2VsTGWp_lpE/s1600/BPDU-Filter.png" imageanchor="1" style="margin-left:1em; margin-right:1em"><img border="0" height="176" width="400" src="http://4.bp.blogspot.com/-m2_EHC3zKMc/UECr5KMtZ9I/AAAAAAAAFHE/2VsTGWp_lpE/s400/BPDU-Filter.png" /></a></div>
<p>While you can prevent bridging-induced forwarding loops with the combination of <em>BPDU filter</em> and <em>reject forged transmits </em>(described in more details in <a href="http://blog.ioshints.info/2011/11/virtual-switches-need-bpdu-guard.html">my original blog post</a>), you’re still avoiding the symptoms, not fixing the problem. Any VM doing unauthorized bridging should be immediately disconnected from the vSwitch – which just might prompt its administrator to correct the faulty settings. </p>
<p>Instead of that, VMware unfortunately decided to go down the familiar <em>never ever disturb the VM, let’s just pretend everything is OK </em>route (and it’s definitely easier to implement <em>drop packets with SNAP value 0x010B </em>code than <em>shut down the offending interface </em><em>and log the event</em> one).</p>
<p><strong>Summary:</strong> vSwitch BPDU filter is a great step in the right direction, but we still need the solution (BPDU Guard) not a band-aid combo. Oh, and did I mention that neither <em>BPDU filter</em> nor <em>reject forged transmits</em> are enabled by default?</p>
<h4>More information</h4><p>To learn more about VMware networking, watch the recoding of my <a href="http://www.ipspace.net/VMware_Networking_Deep_Dive">VMware Networking Deep Dive</a> webinar (also available as part of the <a href="http://www.ipspace.net/Subscription">yearly subscription</a>).</p>

